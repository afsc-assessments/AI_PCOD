# Sensitivity analysis workflow
# Author: Matthieu VERON
# Contact: mveron@uw.edu

# This script houses the material needed to set up the sensitivity analysis
# workflow. It has to be run only once at the beginning.


rm(list = ls(all.names = TRUE))

detach("package:here", unload=TRUE)
setwd("/Users/ingrid.spies/Documents/AI_cod-assessment/AI_Pcod_2023")
library(here)

# 1. Set up ----

# load packages ----

updateKableExtra <- FALSE # Needed the first time
if(updateKableExtra)
  devtools::install_github(repo="haozhu233/kableExtra", ref="a6af5c0")
library(kableExtra)

# Local declarations ----
fsep <- .Platform$file.sep

# Set directories ----
dir_model <- file.path(here::here(), "models", fsep = fsep)
dir_script <- file.path(here::here(), "R", fsep = fsep)


# Set up the Sensitivity Analysis root folders ----
dir_SensAnal <- file.path(dir_model, "Sensitivity_Anal", fsep = fsep)
dirScript_SensAnal  <- file.path(dir_script, "Stock_Synthesis","Sensitivity_Anal", fsep = fsep)

if(!dir.exists(dir_SensAnal))
  dir.create(dir_SensAnal)
if(!dir.exists(dirScript_SensAnal))
  dir.create(dirScript_SensAnal, recursive = TRUE)

# load functions ----
source(file.path(dir_script, "utils", "sensitivity_analysis_utils.R", fsep = fsep))
# ----------------------------------------------------------


# 2. Create the materials needed for the sensitivity analyses ----
# ---------------------------------------------------------- #
# Summary_Sensitivity_analysis.pdf - Summary of all SA
# Models_Sensitivity_analysis.pdf - Models, names, individual directory
# SA_info.RData - data to build the documents

if(!file.exists(file.path(dir_SensAnal, "Summary_Sensitivity_analysis.pdf", fsep = fsep))){ 
  
  # Create the Data that summarizes the SA already done ----
  Topic <- data.frame(
    Topic = c("transition","landings", "discards", "surveys", "biological_Info", "model"),
    Nam = c("0. Transition","1. Landings", "2. Discards", "3. Surveys", "4. Biological Info", "5. Model"),
    ID = 0:5) 
  
  SumUp <- data.frame(matrix("", nrow = length(Topic$Topic), ncol = 11))
  colnames(SumUp) <- c("SA number","Topic",'Author',"Date",
                       "Folder","Script model","Script results",
                       "Base model","New model","Object","Features")
  
  SumUp$`SA number` <- c("Item 0.0","Item 1.1", "Item 2.1","Item 3.1","Item 4.1","Item 5.1")
  SumUp$Topic <- Topic$Topic
  SumUp$Object <- c("Bridging","Adding 2023 catch","Discard as fleet", "Adding 2023 surveys","Growth","Add fleet")
  
  # Create the .pdf file that summarizes the existing models
  Models_SA <-  data.frame(
    ID_SA = c(""),
    Topic = c(""),
    Object = c("M22_0"),
    nam_model = c("M22_0"),
    descr = c("2022 Assessment M22.0"
    ),
    paths = c(file.path("models","M22_0"))
  )
  colnames(Models_SA) <- c("SA number","Topic","Object",'Model name',"Description",
                           "path")

  
  # Create the Summary_Sensitivity_analysis.pdf file that summarizes all SA
  suppressMessages(SumUp <- update_SA_table(SumUp = SumUp, dir_SensAnal = dir_SensAnal))
  cat("\n The Summary_Sensitivity_analysis.pdf file has been created.\n")
  SumUp <- SumUp[1,]
  SumUp <- SumUp  %>% 
    dplyr::mutate(Author = "Ingrid Spies",
                  Date = "2023-07-28",
                  Folder = file.path("models", fsep = fsep),
                  'Script model' = "Run_base_model.R", 
                  'Script results' = "Run_base_model.R",
                  'Base model' = "M22_0"
    )
  # Create the Models_Sensitivity_analysis.pdf file that summarizes all SA models
  
  suppressMessages(Models_SA <- update_Models_SA_table(Models_SA = Models_SA,
                                                       dir_SensAnal = dir_SensAnal))
  cat("\n The Models_Sensitivity_analysis.pdf file has been created.\n")
  
  # Save the data
  SA_info <- list(SumUp = SumUp, Models_SA = Models_SA)
  if(!file.exists(file.path(dirScript_SensAnal, "SA_info.RData", fsep = fsep)))
    save(SA_info, file = file.path(dirScript_SensAnal, "SA_info.RData", fsep = fsep))
}
# ----------------------------------------------------------

