---
title: "2A. Assessment of the Pacific cod stock in the Aleutian Islands"
output:
  pdf_document:
    fig_caption: true
  word_document: default
---

---
header-includes:
 \usepackage{booktabs}
 \usepackage{float}
 \usepackage{graphicx}
 \usepackage{subcaption} 



geometry:
  left=1in,right=1in,top=1in,bottom=1in

---


\begin{centering}
\fontfamily{cmr}
\fontsize{10}{12}
  Ingrid Spies, Steve Barbeaux, Melissa Haltuch, Pete Hulson, Ivonne Ortiz, Laura Spencer, and Sandra Lowe \\
\selectfont
  Alaska Fisheries Science Center, National Marine Fisheries Service \\
  National Oceanic and Atmospheric Administration \\ 
  7600 Sand Point Way NE., Seattle, WA 98115-6349 \\
  {`r format(Sys.time(), '%d %B, %Y')`}\\
  
  \includegraphics[width=1.5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/data/qrcode_github.com.png}

\end{centering}


This report may be cited as:
Spies, I., Barbeaux, S., Haltuch, M., Hulson, P., Ortiz, I., Spencer, L., and Lowe, S. 2025. Assessment of the Pacific cod stock\ in the Aleutian Islands. North Pacific Fishery Management Council, Anchorage, AK. Available from https://www.npfmc.org/library/safe-reports/.



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(kableExtra)
library(stringr)
library(sjlabelled)
library(sjmisc)
library(r4ss)
library(data.table)
library(sizeMat)
library(ggthemes)
library(plotrix)
library(reshape2)
library(dplyr)
library(png)
library(grid)
library(gridExtra)
library(devtools)
library(readr)
library(captioner)

#install.packages("/Users/ingrid.spies/Documents/AI_PCOD/2025/R/captioner_2.2.3.tar.gz", repos = NULL, type = "source")

knitr::opts_chunk$set(fig.align = 'left')

knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache=FALSE,results="asis")

f.ref <- function(x) {
  stringr::str_extract(table_nums(x), "[^:]*")
}

table_nums <- captioner::captioner(prefix = "Table 2A.",levels=1,auto_space = FALSE)
figure_nums <- captioner::captioner(prefix="Figure 2A.",levels = 1, auto_space = FALSE)

thisyr    = 2025
lastyr    = thisyr-1
nextyr    = thisyr+1

#AKFIN under Observer reports 8/11/2025
AI_len_fish=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/norpac_length_report_AI_Pcod_8_11_2025.csv",header=TRUE)


FLF24=vector() #2198 lengths
FLF25=vector() #774 lengths

for(i in 1:143){ #There are 143 lengths and these are in cm.
    FLF24[i]=sum(AI_len_fish$Frequency[which(AI_len_fish$Length_cm==i&AI_len_fish$Year==2024)])
  FLF25[i]=sum(AI_len_fish$Frequency[which(AI_len_fish$Length_cm==i&AI_len_fish$Year==2025)])
}

#This is the number of unique hauls for fishery length data.
Yr=seq(1990,2025,1)
haulz=vector()
for(i in 1:length(Yr)){
  haulz[i]=length(unique(AI_len_fish$Haul.Join[which(AI_len_fish$Year==Yr[i])]))
}


#Needed a special query for data from 1991 and 1992
cat9192=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/AIcod_catch_1991_1992.csv",header=TRUE)

catchLOC=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/Spies - AI Pcod NORPAC_8_11_25.csv",header=TRUE)

#by full months
Num_months=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$MONTH<8&catchLOC$YEAR>2019&catchLOC$YEAR<2025)])

Num_Aug=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$MONTH==8&catchLOC$DAY<12&catchLOC$YEAR>2020&catchLOC$YEAR<2025)])

#Just in September
Denom_months=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$YEAR>2019&catchLOC$YEAR<2025)])

prop=(Num_months+Num_Aug)/(Denom_months)

cat25=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/GroundfishTotalCatch_AICod_8_11_25.csv",header=TRUE)

yrs=as.numeric(names(table(cat25$Year)))
cat25AI=vector();
cat25trw=vector();
cat25llpot=vector();
cat25ll=vector();
cat25pot=vector();
cat25other=vector();
for(i in 1:length(yrs)){
  cat25AI[i]=sum(cat25$Catch..mt.[which(cat25$Year==yrs[i])])
  cat25trw[i]=sum(cat25$Catch..mt.[which(cat25$Year==yrs[i]&cat25$Gear%in%c("BTR","NPT","PTR","TRW"))])
  cat25llpot[i]=sum(cat25$Catch..mt.[which(cat25$Year==yrs[i]&cat25$Gear%in%c("HAL","POT"))])
  cat25ll[i]=sum(cat25$Catch..mt.[which(cat25$Year==yrs[i]&cat25$Gear%in%c("HAL"))])
  cat25pot[i]=sum(cat25$Catch..mt.[which(cat25$Year==yrs[i]&cat25$Gear%in%c("POT"))])
  cat25other[i]=sum(cat25$Catch..mt.[which(cat25$Year==yrs[i]&cat25$Gear%in%c("GIL","JIG","OTH"))])
}

cat25AI[35]#Total for 2025 as of August 11 is 2873.204
cat25trw[35]/prop#4625.97
cat25ll[35]/prop#308.6995
cat25pot[35]/prop#0
cat25other[35]/prop#0
cat25AI[35]/prop#4934.67t is the total estimate for 2025. Prop=0.5822486 as of August 11 2025

GTC=cbind(cat25trw,cat25ll,cat25pot,cat25other,cat25AI)
#GTC[35,]=GTC[35,]/prop #keep this table without the extrapolated values

colnames(GTC)=c("Trawl","Longline","Pot","Other","Total")
write.csv(GTC,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/GTC.csv")

fish_catch=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/GTC.csv",header=TRUE)

#SS3 models
Dir_M24_1=("/Users/ingrid.spies/Documents/AI_PCOD/2025/Models/M24_1_data/run")
M24_1 <- SS_output(Dir_M24_1)

#exploitable biomass (by the survey)
#expbio=retroSummary1$indices$Vuln_bio[which(retroSummary1$indices$imodel==1&retroSummary1$indices$Yr==2025)]
expbio25=999

###Code for conditional length at age

#age1=read.csv("/Users/ingrid.spies/Downloads/AIcodages2024plus.csv",header=TRUE)
#age2=age1[which(age1$AGE>0),]
#age2=age2[which(age2$Year>1990),]
#nyrs=length(table(age2$Year))
#Yrs=as.numeric(names(table(age2$Year)))
#Year=rep(Yrs,each=13)
#Age=rep(seq(1,13),nyrs)
#Frequency=matrix(0,13,14)

#for (i in 1:nyrs){
#  for(j in 1:13){
#    Frequency[j,i]=length(age2$AGE[which(age2$AGE==j&age2$Year==Yrs[i])])
#  }
#}
#rownames(Frequency)=c(1:13)
#colnames(Frequency)=Yrs

#FrequencyN=matrix(0,13,14)
#for(i in 1:nyrs){
#FrequencyN[,i]=Frequency[,i]/sum(Frequency[,i])
#}

#Freq=reshape2::melt(FrequencyN)

#AF=data.frame(cbind(Year,Freq,Age))
#colnames(AF)=c("Year","Var1","Year2","Frequency","Age")

#ggplot(AF, aes(Age,Year)) +
# geom_tile(aes(fill = Frequency),colour = "lightgrey")+
# scale_fill_gradient(low = "white",high = "darkblue")+
# ggtitle("AI cod survey observed age frequencies (normalized by year)")+theme_bw()+ 
# scale_y_continuous(breaks=Year,labels=Year)

#Set up length freqs for the AI cod model

#lens=c(0.5, 1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 17.5, 18.5, 19.5, 20.5, 21.5, 22.5, 23.5, 24.5, 25.5, 26.5, 27.5, 28.5, 29.5, 30.5, 31.5, 32.5, 33.5, 34.5, 35.5, 36.5, 37.5, 38.5, 39.5, 40.5, 41.5, 42.5, 43.5, 44.5, 45.5, 46.5, 47.5, 48.5, 49.5, 50.5, 51.5, 52.5, 53.5, 54.5, 55.5, 56.5, 57.5, 58.5, 59.5, 60.5, 61.5, 62.5, 63.5, 64.5, 65.5, 66.5, 67.5, 68.5, 69.5, 70.5, 71.5, 72.5, 73.5, 74.5, 75.5, 76.5, 77.5, 78.5, 79.5, 80.5, 81.5, 82.5, 83.5, 84.5, 85.5, 86.5, 87.5, 88.5, 89.5, 90.5, 91.5, 92.5, 93.5, 94.5, 95.5, 96.5, 97.5, 98.5, 99.5, 100.5, 101.5, 102.5, 103.5, 104.5, 105.5, 106.5, 107.5, 108.5, 109.5, 110.5, 111.5, 112.5, 113.5, 114.5, 115.5, 116.5, 117.5, 118.5, 119.5, 120.5, 121.5, 122.5, 123.5, 124.5, 125.5, 126.5, 127.5, 128.5, 129.5, 130.5, 131.5, 132.5, 133.5, 134.5, 135.5, 136.5, 137.5, 138.5, 139.5, 140.5, 141.5, 142.5)
#First length bin is 0 to 0.5.
#X=matrix(0,143,13)
#lens=seq(10,1430,10)
#age1_2024=age1[which(age1$Year==2024),]
#table(age1_2024$LENGTH)
#for(i in 1:143){
#  for(j in 1:13){
#  X[i,j]=nrow(age1_2024[which(age1_2024$LENGTH==lens[i]&age1_2024$AGE==j),])
#};print(j)}

#rownames(X)=lens
#colnames(X)=seq(1,13,1)

```



```{r calcs,echo=FALSE,results=FALSE}
report=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/Thompson - PCod Total Catch by Jurisdiction_8_11_25.csv",header=TRUE)
#Retained and discarded Pacific Cod catch in all target fisheries, reported by subarea, jurisdiction, month, and gear. Source: NMFS AKRO BLEND/Catch Accounting System; available 1991-present.Time run: 10/26/2023 5:54:08 AM
yrs=as.numeric(names(table(catchLOC$YEAR)))
pot=vector()
for(i in 1:length(yrs)){
 pot[i]=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$YEAR==yrs[i]&catchLOC$GEAR==6)])
}
cbind(yrs,pot/1000)

yrs2=as.numeric(names(table(report$Year)))
potF=vector();potS=vector();llF=vector();llS=vector();trawlF=vector();trawlS=vector()
for(i in 1:length(yrs)){
 trawlF[i]=sum(report$Catch..mt.[which(report$Gear%in%c("BTR","PTR","TRW","NPT")&report$Year==yrs[i]&report$State.Federal.Fishery=="F")])
  trawlS[i]=sum(report$Catch..mt.[which(report$Gear%in%c("BTR","PTR","TRW","NPT")&report$Year==yrs[i]&report$State.Federal.Fishery=="S")]) 
   llF[i]=sum(report$Catch..mt.[which(report$Gear=="HAL"&report$Year==yrs[i]&report$State.Federal.Fishery=="F")])
  llS[i]=sum(report$Catch..mt.[which(report$Gear=="HAL"&report$Year==yrs[i]&report$State.Federal.Fishery=="S")])  
 potF[i]=sum(report$Catch..mt.[which(report$Gear=="POT"&report$Year==yrs[i]&report$State.Federal.Fishery=="F")])
  potS[i]=sum(report$Catch..mt.[which(report$Gear=="POT"&report$Year==yrs[i]&report$State.Federal.Fishery=="S")])
}

cgear=cbind(yrs,round(pot/1000),round(potS),round(potF),round(llS),round(llF),round(trawlS),round(trawlF))
colnames(cgear)=c("Year","IS report pot catch","Thompson pot catch State","Thompson pot catch Federal","Longline state","Longline federal","Trawl state","Trawl federal")
write.csv(cgear,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2025/cgear.csv")

POT_prop=as.numeric(gsub(",","",fish_catch$Pot))/sum(as.numeric(gsub(",","",fish_catch$Total)))
POT_prop21_25=mean(POT_prop[31:35])#Proportion of pot out of all fisheries (state and federal)
Jig_avg=round(mean(report$Catch..mt.[which(report$Gear=="JIG"&report$State.Federal.Fishery=="F")]),0)#in tons...

#Proportion by gear in state catches
cgearSTATE=cgear[,3]+cgear[,5]+cgear[,7]
statepot=cgear[,3]/cgearSTATE
stateLL=cgear[,5]/cgearSTATE
stateTRAWL=cgear[,7]/cgearSTATE

#Proportion by gear in federal catches
cgearFED=cgear[,4]+cgear[,6]+cgear[,8]
FEDpot=cgear[,4]/cgearFED
FEDLL=cgear[,6]/cgearFED
FEDTRAWL=cgear[,8]/cgearFED

State_prop=round(sum(report$Catch..mt.[which(report$State.Federal.Fishery=="S"&report$Year==2025)])/sum(report$Catch..mt.[which(report$Year==2025)]),2)

catAI=cat25
W_cat=sum(catAI$Catch..mt.[which(catAI$NMFS.Area==543&catAI$Year>2020)])
C_cat=sum(catAI$Catch..mt.[which(catAI$NMFS.Area==542&catAI$Year>2020)])
E_cat=sum(catAI$Catch..mt.[which(catAI$NMFS.Area==541&catAI$Year>2020)])
tot=sum(catAI$Catch..mt.[which(catAI$Year>2020)])

#All selectivity curves were implemented as double normal, which contains six parameters, but only two were estimated (selectivity parameters 1 and 3). This allows for monotonically increasing asymptotic selectivity, and was configured so that the second double normal defining the descending slope was at the upper bound and only the first upward sloping normal was used to model selectivity. A third parameter was estimated in the case of dome-shaped selectivity. 




```

# Executive summary

The Aleutian Islands (AI) and eastern Bering Sea (EBS) Pacific cod stocks were first managed separately in 2014. Between 2014 and 2023, age-structured models were explored in assessments but harvest specifications for Aleutian Islands (AI) Pacific cod were managed under Tier 5. In 2024, an age-structured model, Model 24.1, was accepted by the Plan Team and SSC for setting management targets. This document presents Model 24.1 updated with data through the end of 2024 and through August 11, 2025.

Age structured models:

* Model 24.1: This model includes a timeblock on natural mortality during recent years in which the Aleutian Islands has experienced heatwave conditions, 2016 - 2025. The breakpoint between 2015 and 2016 corresponds to a shift to warmer temperatures in the Aleutian Islands during the past decade (Xiao and Ren 2022). 

### Summary of changes in assessment inputs

The following substantive changes have been made to the Aleutian Islands Pacific cod age structured assessment relative to the November `r thisyr-1` assessment. 

#### Changes in the input data (Tier 3 models)

*	Realized catches for `r thisyr-1`, as well as a preliminary catch estimate through August 11, `r thisyr`. The current year's catch was projected to the end of the year based on the proportion caught over the past 5 years after this the period prior to August 11.
*	Commercial fishery size compositions for `r thisyr-1`, as well as preliminary size composition from the `r thisyr` commercial fisheries through August 11.
* The fishery length composition sample sizes were updated with the number of hauls per year, weighted such that the mean is equivalent to the mean survey input sample size.
* The 2024 conditional age at length and total extrapolated numbers at age were added to the data.

#### Changes in the assessment methodology

* The timeblock on natural mortality from 2016-2025 was estimated. 
* SS3 was updated to the most recent version, 3.30.24.

## Summary of Results  

The 2025 catch of Pacific cod in the Aleutian Islands as of August 11, `r thisyr` was `r formatC(fish_catch[35,6],format="d",big.mark=",")` t.  Over the past 5 years (`r thisyr-5` - `r thisyr-1`), `r 100*round(prop,3)`% of the catch has taken place by this date. Therefore, the full year's estimate of catch in `r thisyr` was extrapolated to be `r formatC(fish_catch[35,6]/prop,big.mark=",",format="d")` t. This is lower than the average catch over the past five years of `r formatC(mean(fish_catch[30:34,6]),big.mark=",",format="d")` t. 

Model 24.1 estimated a total biomass of `r formatC(M24_1$timeseries$Bio_all[38],format="d",big.mark=",")` t for 2026, 