---
title: "2A. Preliminary assessment of the Pacific cod stock\ in the Aleutian Islands"
output:
  pdf_document:
    fig_caption: true

---

---
header-includes:
 \usepackage{booktabs}
 \usepackage{float}
 \usepackage{graphicx}
 \usepackage{floatrow}
 \usepackage{caption}
 \usepackage{subcaption}
 \usepackage{subfigure}
geometry:
  left=1in,right=1in,top=1in,bottom=1in

---


\begin{centering}
\fontfamily{cmr}
\fontsize{10}{12}
  Ingrid Spies, Maia Kapur, Steve Barbeaux, Melissa Haltuch, Pete Hulson, Ivonne Ortiz, Sandra Lowe \\
\selectfont
  Alaska Fisheries Science Center, National Marine Fisheries Service \\
  National Oceanic and Atmospheric Administration \\ 
  7600 Sand Point Way NE., Seattle, WA 98115-6349 \\
  {`r format(Sys.time(), '%d %B, %Y')`}\\
\end{centering}



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(kableExtra)
library(stringr)
library(sjlabelled)
library(sjmisc)
library(r4ss)
library(FSA)
library(nlstools)
library(data.table)
library(sizeMat)
library(ggthemes)
library(plotrix)
library(reshape2)
library(dplyr)
library(png)
library(grid)
library(gridExtra)
library(devtools)
library(captioner)
library(readr)




knitr::opts_chunk$set(fig.align = 'left')

knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache=FALSE,results="asis")

f.ref <- function(x) {
  stringr::str_extract(table_nums(x), "[^:]*")
}

table_nums <- captioner::captioner(prefix = "Table 2A.",levels=1,auto_space = FALSE)
figure_nums <- captioner::captioner(prefix="Figure 2A.",levels = 1, auto_space = FALSE)

thisyr    = 2024
lastyr    = thisyr-1
nextyr    = thisyr+1

Dir_RMD="/Users/ingrid.spies/Documents/AI_PCOD/2024/AIPcod2024"

#AKFIN under Observer reports 4/25/24
AI_len_fish=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/norpac_length_report_AI_Pcod_8_14_24.csv",header=TRUE)

#Needed a special query for data from 1991 and 1992
cat9192=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/AIcod_catch_1991_1992.csv",header=TRUE)

#AKFIN Special analyst report - Spies. 	Thompson - PCod Total Catch by Jurisdiction  
catchLOC=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Spies - AI Pcod NORPAC_8_14_24.csv",header=TRUE)

#by full months
Num_months=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$MONTH<9&catchLOC$YEAR>2018&catchLOC$YEAR<2024)])

Num_August=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$MONTH==9&catchLOC$DAY>15&catchLOC$YEAR>2018&catchLOC$YEAR<2024)])

#Just in August
Denom_months=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$YEAR>2018&catchLOC$YEAR<2024)])
Denom_August=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$YEAR>2018&catchLOC$MONTH==9&catchLOC$YEAR<2024)])

prop=(Num_months+Num_August)/(Denom_months+Denom_August)


cat24=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/GroundfishTotalCatch_AICod_8_14_24.csv",header=TRUE)

yrs=as.numeric(names(table(cat24$Year)))
cat24AI=vector();
cat24trw=vector();
cat24llpot=vector();
cat24ll=vector();
cat24pot=vector();
cat24other=vector();
for(i in 1:length(yrs)){
  cat24AI[i]=sum(cat24$Catch..mt.[which(cat24$Year==yrs[i])])
  cat24trw[i]=sum(cat24$Catch..mt.[which(cat24$Year==yrs[i]&cat24$Gear%in%c("BTR","NPT","PTR","TRW"))])
  cat24llpot[i]=sum(cat24$Catch..mt.[which(cat24$Year==yrs[i]&cat24$Gear%in%c("HAL","POT"))])
  cat24ll[i]=sum(cat24$Catch..mt.[which(cat24$Year==yrs[i]&cat24$Gear%in%c("HAL"))])
  cat24pot[i]=sum(cat24$Catch..mt.[which(cat24$Year==yrs[i]&cat24$Gear%in%c("POT"))])
  cat24other[i]=sum(cat24$Catch..mt.[which(cat24$Year==yrs[i]&cat24$Gear%in%c("GIL","JIG","OTH"))])
}
cat24AI[34]/prop#3949.798t is the total estimate for 2024. Prop=0.2955 as of end of August
cat24AI[34]#Total for 2024 as of end of August
cat24trw[34]/prop#3419.545
cat24ll[34]/prop#46.20484
cat24pot[34]/prop#4432.612
cat24other[34]
GTC=cbind(cat24trw,cat24ll,cat24pot,cat24other,cat24AI)
colnames(GTC)=c("Trawl","Longline","Pot","Other","Total")
write.csv(GTC,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/GTC.csv")
#October ~18


fish_catch=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/GTC.csv",header=TRUE)


#SS3 models
Dir_M24_1=("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run")
Dir_M24_0=("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_0/run")
Dir_RMD="/Users/ingrid.spies/Documents/AI_PCOD/2024/AIPcod2024"
M24_0 <- SS_output(Dir_M24_0)
M24_1 <- SS_output(Dir_M24_1)

retroModelsM1 <- SSgetoutput(
  dirvec = file.path(Dir_M24_1, "retrospectives", paste("retro", 0:-10, sep = ""))
)

retroSummary1 <- SSsummarize(retroModelsM1)

#exploitable biomass (by the survey)
expbio=retroSummary1$indices$Vuln_bio[which(retroSummary1$indices$imodel==1&retroSummary1$indices$Yr==2024)]

#Trying to get to how the mocel calculates $Bio_smry
#Age selectivity

asel=M24_1$ageselex[M24_1$ageselex$Factor == "Asel2", ]
#asel[which(asel$Yr==2025&asel$Fleet==1),][9:21] #Fishery selectivity
#Asel=asel[which(asel$Yr==2025&asel$Fleet==2),][9:21] #Survey selectivity

#Best guess for total biomass
#natage=M24_1$natage[which(M24_1$natage$Yr==2024&M24_1$natage$`Beg/Mid`=="M"),][14:26] #natatage
#wtage=M24_1$wtatage[which(M24_1$wtatage$Yr==2024&M24_1$wtatage$Fleet==2),][8:20] 
#sum(natage*wtage)

#Should catchablity be added? exp(-0.110266) No, it doesnot work
#natage=M24_1$natage[which(M24_1$natage$Yr==2024&M24_1$natage$`Beg/Mid`=="M"),][14:26] #natatage
#wtage=M24_1$wtatage[which(M24_1$wtatage$Yr==2024&M24_1$wtatage$Fleet==2),][8:20] 
#sum(natage*wtage*0.8955959)

#Best guess for total exploitable biomass - MATCHES!!!??
natage=M24_1$natage[which(M24_1$natage$Yr==2024&M24_1$natage$`Beg/Mid`=="M"),][14:26] #natatage
wtage=M24_1$wtatage[which(M24_1$wtatage$Yr==2024&M24_1$wtatage$Fleet==2),][8:20] 
Aselsrv=asel[which(asel$Yr==2025&asel$Fleet==2),][9:21]
expbio25=sum(natage*wtage*Aselsrv)

fsep = "/"

mod.sum <- SSsummarize(list(M24_0,M24_1))

SensiMod <- SSgetoutput(dirvec = c(Dir_M24_0,Dir_M24_1))

names(SensiMod) <- c('M24_0','M24_1')

Version_Summary <- SSsummarize(SensiMod)

SSplotComparisons(Version_Summary,pdf = TRUE,plotdir = file.path(Dir_RMD, fsep = "/"),legendlabels = c('M24_0','M24_1'))

SStableComparisons(Version_Summary)

SensiMod$replist1$parameters$Label[which(SensiMod$replist1$parameters$Phase>0)]

thingnames <- c(
  "Recr_Virgin", "steep", "NatM", "Linf",
  "SmryBio_unfished",
  "SSB_Virg", "SSB_2024",
  "Bratio_2024", "SPRratio_2024", "Ret_Catch_MSY", "Dead_Catch_MSY",
  "OFLCatch_2024","SR_LN(R0)",
  "LnQ","Size_DblN_peak_FshComb","Size_DblN_top_logit_FshComb", 
  "Size_DblN_ascend_se_FshComb(1)","Size_DblN_peak_Srv(2)", "Size_DblN_ascend_se_Srv(2)" )

likenames <- c(
  "TOTAL", "Survey", "Length_comp", "Age_comp",
  "Discard", "Mean_body_wt", "Recruitment", "priors"
)

tmp <- purrr::transpose(SensiMod)$parameters %>%
  purrr::map_df(~dplyr::as_tibble(.x), .id = 'Model') %>%
  dplyr::select(Model, Label, Value, Phase, Min, Max, Init,
                Gradient, Pr_type, Prior, Pr_SD, Pr_Like,
                LCI95 = `Value-1.96*SD`, UCI95 = `Value+1.96*SD`)

tmp %>%
  readr::write_csv(paste(Dir_RMD, 'Update_Data_comparison_table_all_params.csv', sep = fsep))

tmp %>%
  dplyr::filter(grepl('LnQ|R0', Label)) %>%
  tidyr::pivot_wider(id_cols = c(Label, Phase), names_from = Model, values_from = Value) %>%
  readr::write_csv(paste(Dir_RMD, 'Update_Data_comparison_table_lnQ_SRlnR0.csv', sep = fsep))

out <- SStableComparisons(Version_Summary,
                          names = thingnames,
                          likenames = likenames)
names(out) <- c('Label','M24_0','M24_1')

out %>%readr::write_csv(paste(Dir_RMD,'Update_Data_comparison_table_likelihoods_and_brps1.csv', sep = fsep))




Srv_this=M24_0$cpue$Obs[which(M24_0$cpue$Yr==2022&M24_0$cpue$Fleet_name=="Srv")]
Srv_thisF=formatC(Srv_this,format="d",big.mark=",")

Srv_last=M24_0$cpue$Obs[which(M24_0$cpue$Yr==2018&M24_0$cpue$Fleet_name=="Srv")]
Srv_lastF=formatC(Srv_last,format="d",big.mark=",")

#run AK scenarios 2024 with M24_1
#write.csv(PM24$Two_year,paste(Dir_M24_1,"Two_year.csv",sep="/"))
#write.csv(PM24$Tables$Catch,paste(Dir_M24_1,"Catch_proj.csv",sep="/"))
#write.csv(PM24$Tables$F,paste(Dir_M24_1,"F_proj.csv",sep="/"))
#write.csv(PM24$Tables$SSB,paste(Dir_M24_1,"SSB_proj.csv",sep="/"))

Two_year=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/Two_year.csv")

Catch_proj=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/Catch_proj.csv")
F_proj=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/F_proj.csv")
SSB_proj=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/SSB_proj.csv")

TotBio_thisF=formatC(M24_0$timeseries$Bio_smry[which(M24_0$timeseries$Yr==thisyr+1)],big.mark=",",format="d")

TotBio_nextF=formatC(M24_0$timeseries$Bio_smry[which(M24_0$timeseries$Yr==thisyr+2)],big.mark=",",format="d")

SSB_thisF=formatC(Two_year$SSB[1],big.mark=",",format="d")
SSB_nextF=formatC(Two_year$SSB[2],big.mark=",",format="d")
FOFL_this=round(Two_year$F35[1],3)
FOFL_next=round(Two_year$F35[2],3)
FABC_this=round(Two_year$F40[1],3)
FABC_next=round(Two_year$F40[2],3)
ABC_this=round(Two_year$C_ABC[1])
ABC_next=round(Two_year$C_ABC[2])
OFL_this=round(Two_year$C_OFL[1])
OFL_next=round(Two_year$C_OFL[2])
ABC_thisF=formatC(ABC_this,big.mark=",",format="d")
ABC_nextF=formatC(ABC_next,big.mark=",",format="d")
OFL_thisF=formatC(OFL_this,big.mark=",",format="d")
OFL_nextF=formatC(OFL_next,big.mark=",",format="d")

B35_this=Two_year$SB35[1]
B35_thisF =formatC(Two_year$SB35[1],big.mark=",",format="d")


#M24_0_Mohns=read.csv(paste(Dir_M24_0a,"/retrospectives1/Mohn.csv",sep=""),header=TRUE)
#Rho_M24_0=round(M24_0_Mohns[11,4],3)

#Tier 5 below M13.2
REMA=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2023/REMA/AI_REMA.csv")

T5bio=REMA$Biomass[nrow(REMA)]#biomass
T5_low90=REMA$LCI[nrow(REMA)]#low90th
T5_upp90=REMA$UCI[nrow(REMA)]#upp90th

#Tier 5 reference points
T5TotBio_this=REMA$Biomass[length(REMA$Biomass)]
T5TotBio_thisF=formatC(T5TotBio_this,digits=0,big.mark=",",format="d")

T5TotBio_next=T5TotBio_this
T5TotBio_nextF=T5TotBio_thisF
T5TotBio_last=54165
T5TotBio_lastF="54,165"

T5m=0.34

T5OFL_this=T5m*T5TotBio_this
T5OFL_thisF=formatC(T5OFL_this,digits=0,format="d",big.mark=",")

T5OFL_this24_2=0.417*T5TotBio_this
T5OFL_thisF24_2=formatC(T5OFL_this24_2,digits=0,format="d",big.mark=",")

T5OFL_next=T5OFL_this
T5OFL_nextF=T5OFL_thisF
T5OFL_last=18416
T5OFL_lastF="18,416"

T5ABC_this=0.75*T5OFL_this
T5ABC_thisF=formatC(T5ABC_this,digits=0,big.mark=",",format="d")

T5ABC_this24_2=0.75*T5OFL_this24_2
T5ABC_thisF24_2=formatC(T5ABC_this24_2,digits=0,big.mark=",",format="d")

T5ABC_next=T5ABC_this
T5ABC_nextF=T5ABC_thisF
T5ABC_last=13812
T5ABC_lastF="13,812"

T5TAC_lastF="8,425"

T5ABC_2024="12,431" #This is the actual ABC
T5OFL_2024="18,416"  #Actual OFL

#`r opts_chunk$set(cache=TRUE)`


#Evaluate FABC and FOFL 
#In that code:
#F=data.table(mods1[[8]]$sprseries)[Yr%in%c(SYR:EYR)]$F_report
#F=data.table(mods1[[i]]$sprseries)[Yr%in%c(SYR:EYR)]$F_report


#Calculate the probabiliyt of being below B20%
M24_1DT=data.table(M24_1$derived_quants)
M24_1DT[Label=="SSB_2024"]$Value
SSB0_M24_1<-data.table(M24_1$derived_quants)[Label=='SSB_unfished']$Value
x=rnorm(100000, M24_1DT[Label=="SSB_2024"]$Value, M24_1DT[Label=="SSB_2024"]$StdDev)
BX2023=data.table(M24_1$derived_quants)[Label=='SSB_2024']$Value/SSB0_M24_1

x2=x/SSB0_M24_1
P_belowB20=round((sum(x2<=0.2)/100000),2)

#multiplying a random variable by a constant b causes the variance to be multiplied by b^2
est=M24_1DT[Label=="SSB_2026"]$Value/SSB0_M24_1
var=(M24_1DT[Label=="SSB_2026"]$StdDev)^2*(1/SSB0_M24_1)^2
sd=sqrt(var)
P_belowB20_2=pnorm(.2,est,sd);P_belowB20_2

#data.table(M24_0$derived_quants)[Label=='SSB_2023']$Value/SSB0_M24_0

#This is the scenarios file


#write.csv(PM24$Two_year,"/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/Two_year.csv")

Rho_24_0=round(read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_0/run/retrospectives2/Mohn.csv",header=TRUE)[11,4],3)
Rho_24_1=round(read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/retrospectives/Mohn.csv",header=TRUE)[11,4],3)

M24_1_Two_Year=read.csv(file.path(Dir_M24_1,'AK_Scenarios','Two_Year.csv'))

#M24_0_Two_Year=read.csv(file.path(Dir_M24_0,'AK_Scenarios','Two_Year.csv'))


```


```{r echo=FALSE, out.width = "30%", fig.align = "center"}
#knitr::include_graphics("/Users/ingrid.spies/Documents/AI_PCOD/Assessment/qrcode_github.com.png") 


```


```{r calcs,echo=FALSE,results=FALSE}
report=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Thompson - PCod Total Catch by Jurisdiction_8_14_24.csv",header=TRUE)
#Retained and discarded Pacific Cod catch in all target fisheries, reported by subarea, jurisdiction, month, and gear. Source: NMFS AKRO BLEND/Catch Accounting System; available 1991-present.Time run: 10/26/2023 5:54:08 AM
yrs=as.numeric(names(table(catchLOC$YEAR)))
pot=vector()
for(i in 1:length(yrs)){
 pot[i]=sum(catchLOC$EXTRAPOLATED_WEIGHT[which(catchLOC$YEAR==yrs[i]&catchLOC$GEAR==6)])
}
cbind(yrs,pot/1000)

yrs2=as.numeric(names(table(report$Year)))
potF=vector();potS=vector();llF=vector();llS=vector();trawlF=vector();trawlS=vector()
for(i in 1:length(yrs)){
 trawlF[i]=sum(report$Catch..mt.[which(report$Gear%in%c("BTR","PTR","TRW","NPT")&report$Year==yrs[i]&report$State.Federal.Fishery=="F")])
  trawlS[i]=sum(report$Catch..mt.[which(report$Gear%in%c("BTR","PTR","TRW","NPT")&report$Year==yrs[i]&report$State.Federal.Fishery=="S")]) 
   llF[i]=sum(report$Catch..mt.[which(report$Gear=="HAL"&report$Year==yrs[i]&report$State.Federal.Fishery=="F")])
  llS[i]=sum(report$Catch..mt.[which(report$Gear=="HAL"&report$Year==yrs[i]&report$State.Federal.Fishery=="S")])  
 potF[i]=sum(report$Catch..mt.[which(report$Gear=="POT"&report$Year==yrs[i]&report$State.Federal.Fishery=="F")])
  potS[i]=sum(report$Catch..mt.[which(report$Gear=="POT"&report$Year==yrs[i]&report$State.Federal.Fishery=="S")])
}

cgear=cbind(yrs,round(pot/1000),round(potS),round(potF),round(llS),round(llF),round(trawlS),round(trawlF))
colnames(cgear)=c("Year","IS report pot catch","Thompson pot catch State","Thompson pot catch Federal","Longline state","Longline federal","Trawl state","Trawl federal")
write.csv(cgear,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/cgear.csv")

#####HERE INGRID
POT_prop=as.numeric(gsub(",","",fish_catch$Pot))/sum(as.numeric(gsub(",","",fish_catch$Total)))
POT_prop20_24=mean(POT_prop[30:34])#Proportion of pot out of all fisheries (state and federal)
Jig_avg=round(mean(report$Catch..mt.[which(report$Gear=="JIG"&report$State.Federal.Fishery=="F")]),0)#in tons...

#Proportion by gear in state catches
cgearSTATE=cgear[,3]+cgear[,5]+cgear[,7]
statepot=cgear[,3]/cgearSTATE
stateLL=cgear[,5]/cgearSTATE
stateTRAWL=cgear[,7]/cgearSTATE

#Proportion by gear in federal catches
cgearFED=cgear[,4]+cgear[,6]+cgear[,8]
FEDpot=cgear[,4]/cgearFED
FEDLL=cgear[,6]/cgearFED
FEDTRAWL=cgear[,8]/cgearFED

State_prop=round(sum(report$Catch..mt.[which(report$State.Federal.Fishery=="S"&report$Year==2024)])/sum(report$Catch..mt.[which(report$Year==2024)]),2)

catAI=cat24
W_cat=sum(catAI$Catch..mt.[which(catAI$NMFS.Area==543&catAI$Year>2019)])
C_cat=sum(catAI$Catch..mt.[which(catAI$NMFS.Area==542&catAI$Year>2019)])
E_cat=sum(catAI$Catch..mt.[which(catAI$NMFS.Area==541&catAI$Year>2019)])
tot=sum(catAI$Catch..mt.[which(catAI$Year>2019)])

#All selectivity curves were implemented as double normal, which contains six parameters, but only two were estimated (selectivity parameters 1 and 3). This allows for monotonically increasing asymptotic selectivity, and was configured so that the second double normal defining the descending slope was at the upper bound and only the first upward sloping normal was used to model selectivity. A third parameter was estimated in the case of dome-shaped selectivity. 







```

# Executive summary

The following document is written in a similar style as a full stock assessment, with several omissions. The purpose is to present models for the September Plan Team meeting. 

The Aleutian Islands (AI) and eastern Bering Sea (EBS) Pacific cod stocks were first managed separately in 2014. Since 2014, age-structured models have been explored in assessments but harvest specifications for Aleutian Islands (AI) Pacific cod have been based on Tier 5 methodology.  This document presents two preliminary age structured models for the Aleutian Islands Pacific cod stock using data from 1991 through `r thisyr` (Models 24.0 and 24.1), as well as two Tier 5 harvest specification models (Models 13.4 and 24.2).

### Summary of changes in assessment inputs

The following substantive changes have been made to the Aleutian Islands Pacific cod age structured assessment relative to the November `r thisyr-1` assessment. 

#### Changes in the input data (age structured models)

A version of this model was presented in 2023, with the following data updated for the current year `r thisyr`.

*	Realized catches for the entire `r thisyr-1`, as well as a preliminary catch estimate through August 14, `r thisyr`. The current year's catch was projected to the end of the year based on the proportion caught over the past 5 years during this the period prior to August 14.
*	Commercial fishery size compositions for 1991 - `r thisyr-1`, as well as preliminary size composition from the `r thisyr` commercial fisheries through August 14, weighted by quarter, gear, and NMFS area.
*	Aleutian Islands trawl survey biomass index and size compositions from the 1991 - 2022 (a survey was conducted summer `r thisyr` that will be incorporated in the November assessment).
*	Aleutian Islands trawl survey age composition from 1991 - 2022.

#### Changes in the input data (Tier 5 model)
 
* There has been no change to the input data for Tier 5 model; it uses existing biomass estimates from 1991 - 2022, and will be updated with 2024 data for the November assessment.

#### Changes in the assessment methodology

\
\
The following are features of the age structured models that are consistent with the 2023 models.

* Single sex model, 1:1 male female ratio.
* Survey age and length data were input as conditional age-at-length.
* Recruitment estimated as a mean with lognormally distributed deviations.
* Maturity-at-age was estimated externally using observer data, then input into the model.
* Single-fleet fishery that combines trawl, longline, and pot fishery data, weighted by quarter, gear, and NMFS area, from 1991 - current year (through August 14).
* All parameters were constant over time except for natural mortality after 2015 in Model 24.1.
* Survey and fishery selectivity were modeled as logistic and constant over time. 
* Trawl survey catchability was incorporated analytically.

The following features are new for 2024.

* Initial _F_ was estimated using mean catch from 1981-1990. This improved the recruitment likelihoods and the AIC.
* Natural mortality was estimated externally using _Then_lm_ (http://barefootecologist.com.au/shiny_m.html) and fixed at 0.417, except in Model 24.1 after 2015 (which incorporated a time block on natural mortality). Allowing the model to estimate natural mortality resulted in unrealistic estimates of recruitment and unfished stock size.
* The timeblock on natural mortality estimated a single value (not a base value with devs), resulting in smaller confidence intervals and fewer estimated parameters.
* A Richards growth curve was estimated within the model, providing a better fit to the age composition and survey likelihoods, as well as the AIC. Previous models used the von Bertalanffy growth curve.
* Maximum age was 13+. Previously iterations of the model used 10+ as a plus group. Inclusion of the age 13+ maximum age group improves the survey and age compositions as well as AIC.
* Fishery length composition was reweighted by quarter, gear, and NMFS area, and did not incorporate a plus group (max = 143 cm). Previous models used a plus group of 117+ cm. The addition of length bins up to 143 cm provided the model with observed sizes and improved the fit to the growth curve, selectivity, and length compositions.
* Settlement was fixed to values consistent with GOA and EBS cod assessment models. Specifically, the time of settlement was changed  to indicate that settlement takes place in the same year as spawning, rather than in the following year. This was done for accuracy, consistency, and improved fit to the growth curve. 

Age structured models:

* Model 24.0: This is the base model with features described above.

* Model 24.1: This model only differs from Model 24.0 by implentation of a timeblock on natural mortality from 2016 - 2024.  The breakpoint between 2015 and 2016 corresponds to a shift to warmer temperatures in the Aleutian Islands during the past decade (Xiao and Ren 2022).

Tier 5 random effects model:

* Model 13.4: There has been no change to the input data for Tier 5 model; it uses existing biomass estimates from 1991 - 2022  implemented using the REMA package. The natural mortality estimate used in past models is retained for 2024. The natural mortality estimate (M = 0.34) used in past models is retained for `r thisyr`.

* Model 24.2: This is the same Tier 5 model as 13.4, except it incorporates the natural mortality estimated using _Then_lm_, M = 0.417.

## Summary of Results  

Model 24.1 is the preferred age structured model. The incorporation of a natural mortality time block after 2015 in Model 24.1 improved the fit to the survey index and the overall likelihood over the base Model 24.0 (`r table_nums("TableCompare", display="cite")`). Natural mortality in this timeblock was estimated at `r round(as.numeric(M24_1$Natural_Mortality[37,23]),3)`, which was higher than the natural mortality from 1991-2015, M = `r round(as.numeric(M24_1$Natural_Mortality[25,23]),3)`. AIC was lowest for Model 24.1 (`r table_nums("TableCompare", display="cite")`), indicating a better fit to the data despite the addition of an estimated timeblock parameter. Improvements in Model 24.1 over Model 24.0 are notable in the survey and length composition likelihood components, as well as the fit to the survey index and AIC (`r  figure_nums("survey_index", display="cite")`, `r  table_nums("TableCompare", display="cite")`). Model 24.0 produced an unacceptable Mohn's rho value, `r Rho_24_0`, while Model 24.1 produced a smaller retrospective pattern, `r Rho_24_1` (`r figure_nums("retro_M2",display="cite")`). Model 24.1 estimated a total biomass of `r formatC(M24_1$timeseries$Bio_all[37],format="d",big.mark=",")` t, a spawning biomass of `r formatC(Two_year$SSB[1],big.mark=",",format="d")` t, and an exploitable biomass of `r formatC(expbio25,big.mark=",",format="d")` t for `r thisyr+1`. Model 24.1 ABCs were `r formatC(Two_year$C_ABC[1],big.mark=",",format="d")` t and `r formatC(Two_year$C_ABC[2],big.mark=",",format="d")` t for `r thisyr+1` and `r thisyr+2`. Model 24.1 OFLs were `r formatC(Two_year$C_OFL[1],big.mark=",",format="d")` t and `r formatC(Two_year$C_OFL[2],big.mark=",",format="d")` t for `r thisyr+1` and `r thisyr+2`. 

The Tier 5 ABCs and OFLs for `r thisyr+1` and `r thisyr+2` are the same as estimated in 2022, due to no new survey data. Model 13.4 incorporates this biomass estimate directly in the calculation of reference points; therefore, the random effects model estimated an exploitable biomass of `r formatC(round(REMA$Biomass[32]),format="d",big.mark=",")` t, which resulted in OFLs (`r T5OFL_thisF` t) and ABCs (`r T5ABC_thisF` t) for `r thisyr+1` and `r thisyr+2`. This is comparable with the exploitable survey biomass estimated by Model 24.1 (`r formatC(expbio25,big.mark=",",format="d")` t). Model 24.2 estimated higher OFLs (`r T5OFL_thisF24_2` t) and ABCs (`r T5ABC_thisF24_2` t) for `r thisyr+1` and `r thisyr+2` due to the higher natural mortality parameter. The preferred Tier 5 model is Model 24.2 because the natural mortality estimate is based on the growth rate and maximum age specific to Aleutian Islands Pacific cod. The _Then_lm_ method used to calculate the natural mortality rate for Model 24.2 was also used for the eastern Bering Sea Pacific cod assessment model starting in 2023 (`r  table_nums("Tier5_comparison", display="cite")`).

Overall, the age structured model 24.1 is prefered over a Tier 5 model because it incorporates more data sources (fishery and survey lengths, survey ages, maturity curve) in a likelihood framework, providing a much more comprehensive estimate of the stock status than a random effects model, which simply fits the survey biomass indices. We recommend moving this assessment to a Tier 3 approach.

Catch of Pacific cod as of August 14, `r thisyr` was `r formatC(fish_catch[34,6],format="d",big.mark=",")` t.  Over the past 5 years (`r thisyr-5` - `r thisyr-1`), `r 100*round(prop,3)`% of the catch has taken place by this date. Therefore, the full year's estimate of catch in `r thisyr` was extrapolated to be `r formatC(fish_catch[34,6]/prop,big.mark=",",format="d")` t. This is lower than the average catch over the past five years of `r formatC(mean(fish_catch[29:33,6]),big.mark=",",format="d")` t. 

Summary table for Model 24.2. Note the 2024 accepted ABC and OFL were adjusted from the 2024 model values for OFL and ABC.

\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{As estimated or $\mathit{specified}$ } & \multicolumn{2}{c}{As estimated or $\mathit{recommended}$ }  \\
       & \multicolumn{2}{c|}{$\mathit{last}$ year for:}  & \multicolumn{2}{c}{$\mathit{this}$ year for: }               \\
        Quantity & `r thisyr`      &`r thisyr+1`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
	$M$ (natural mortality rate)	&	0.34	&	0.34	&	0.34	&	0.34 \\
Tier	&	5	&	5	&	5	&	5 \\
Biomass (t)	& `r T5TotBio_lastF` & `r T5TotBio_lastF` & `r T5TotBio_thisF` & `r T5TotBio_nextF`  \\
$F_{OFL}$    	&	0.34	&	0.34	&	0.34	&	0.34	\\
$maxF_{ABC}$   	&	0.255	&	0.255	&	0.255	&	0.255  	\\
$F_{ABC}$       &	0.255	&	0.255	&	0.255	&	0.255        \\
$OFL$    	      & `r T5OFL_2024`  & `r T5OFL_2024`  & `r T5OFL_thisF24_2`  & `r T5OFL_thisF24_2`      \\
$maxABC$    	  & `r T5ABC_2024` & `r T5ABC_2024` & `r T5ABC_thisF24_2` & `r T5ABC_thisF24_2`  \\
$ABC$ 	       & `r T5ABC_2024` & `r T5ABC_2024` & `r T5ABC_thisF24_2` & `r T5ABC_thisF24_2`      \\
\hline
Status	                              &	`r thisyr-2`	      &	 `r thisyr-1`	      &		`r thisyr-1`             &	`r thisyr`          \\
\hline
Overfishing	                          &	No	        &	n/a	      &	No	                       &	n/a                 \\
\hline
\end{tabular}
\end{table}


Summary table for Model 24.1. Natural mortality is provided for two time blocks, 1991-2015, followed by 2016-`r thisyr`.

\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr}
  \hline
       & \multicolumn{2}{c|}{As estimated or $\mathit{specified}$ } & \multicolumn{2}{c}{As estimated or $\mathit{recommended}$ }  \\
       & \multicolumn{2}{c|}{$\mathit{last}$ year for:}  & \multicolumn{2}{c}{$\mathit{this}$ year for: }               \\
        Quantity & `r thisyr`      &`r thisyr+1`   & `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
$M$ (natural mortality rate)          &  0.34   &  0.34   &  `r round(as.numeric(M24_1$Natural_Mortality[25,23]),2)`, `r round(as.numeric(M24_1$Natural_Mortality[37,23]),2)`*   & `r round(as.numeric(M24_1$Natural_Mortality[25,23]),2)`, `r round(as.numeric(M24_1$Natural_Mortality[37,23]),2)`*   \\
Tier                                  &  5   &  5   &  3b   & 3b   \\
Projected total (age 1+) biomass (t)  &  `r T5TotBio_lastF`  &  `r T5TotBio_lastF`  &  `r formatC(M24_1$timeseries$Bio_smry[which(M24_1$timeseries$Yr==thisyr+1)],big.mark=",",format="d")` & `r formatC(M24_1$timeseries$Bio_smry[which(M24_1$timeseries$Yr==thisyr+2)],big.mark=",",format="d")` \\
Projected female spawning biomass (t) &  -  &  -  &  `r formatC(Two_year$SSB[1],big.mark=",",format="d")` & `r formatC(Two_year$SSB[2],big.mark=",",format="d")` \\
$\:\:\:\:\:\:B_{100\%}$                           &  -  &  -  &  `r formatC(Two_year$SB100[1],big.mark=",",format="d")` & `r formatC(Two_year$SB100[2],big.mark=",",format="d")` \\
$\:\:\:\:\:\:B_{40\%}$                            &  -  &  -  &  `r formatC(Two_year$SB40[1],big.mark=",",format="d")` & `r formatC(Two_year$SB40[2],big.mark=",",format="d")`  \\
$\:\:\:\:\:\:B_{35\%}$                            &  -  &  -  &  `r formatC(Two_year$SB35[1],big.mark=",",format="d")` & `r formatC(Two_year$SB35[2],big.mark=",",format="d")` \\
$F_{OFL}$                             &  0.34   &  0.34   &  `r round(Two_year$F35[1],3)`   & `r round(Two_year$F35[2],3)`    \\
$maxF_{ABC}$                          &  0.255  &  0.255  &  `r round(Two_year$F40[1],3)`    & `r round(Two_year$F40[2],3)`    \\
$F_{ABC}$                             &  0.255   &  0.255   &  `r round(Two_year$F40[1],3)`   & `r round(Two_year$F40[2],3)`  \\
$OFL$                                 &  `r T5OFL_2024`  &  `r T5OFL_2024`  &  `r formatC(Two_year$C_OFL[1],big.mark=",",format="d")` & `r formatC(Two_year$C_OFL[2],big.mark=",",format="d")` \\
$maxABC$                              &  `r T5ABC_2024` &  `r T5ABC_2024`  &  `r formatC(Two_year$C_ABC[1],big.mark=",",format="d")` & `r formatC(Two_year$C_ABC[2],big.mark=",",format="d")` \\
$ABC$                                 &  `r T5ABC_2024`  &  `r T5ABC_2024`  & `r formatC(Two_year$C_ABC[1],big.mark=",",format="d")` & `r formatC(Two_year$C_ABC[2],big.mark=",",format="d")` \\
\hline
Status                               & `r thisyr-2`       & `r thisyr-1`      &  `r thisyr-1`             & `r thisyr`          \\
\hline
Overfishing                           & No         & n/a       & No                        & n/a                 \\
Overfished                           & n/a         & No       & n/a                        & No                  \\
Approaching overfished               & n/a         & No       & n/a                        & No                  \\
\hline
\end{tabular}
\begin{tablenotes}
\item 
  \end{tablenotes}
\end{table}

\pagebreak

# Data

The data used in the age structured models include fishery catch and size compositions, survey biomass and standard error, and age compositions from survey data (`r table_nums("data_inline",display="cite")` and `r figure_nums("dataSS3",display="cite")`). Partial catch information for `r thisyr` was available and was extrapolated to estimate the catch for the full year. On average, `r round(100*prop,1)`% of the annual catch occurs by this date, as estimated by catch statistics for the past 5 full years, `r thisyr-5` - `r thisyr-1`. The full year's estimate of catch of Pacific cod in the Aleutian Islands for `r thisyr` was `r formatC(fish_catch[34,6]/prop,format="d",big.mark=",")` t. Overall, catches have decreased for all gear types since 2020 (`r figure_nums("catch_gear",display="cite")`).

The data used in the Tier 5 Model included biomass estimates and associated error for the NMFS Aleutian Island research surveys, 1991-2022 (`r table_nums("srvbio1",display="cite")`), based on data through August 14, 2024.

## Fishery Data   

```{r, message=FALSE,echo=FALSE, results=FALSE}
report=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Thompson - PCod Total Catch by Jurisdiction_8_14_24.csv",header=TRUE)
catz=matrix(0,3,12)
grz=names(table(report$Gear))
#row1:HAL
#row2=NPT,PTR,TRW
#row3=POT
for(i in 1:3){
 for(j in 1:12){
  catz[1,j]=sum(report$Catch..mt.[which(report$Year>2019&report$Month==j&report$Gear=="HAL")])
  catz[2,j]=sum(report$Catch..mt.[which(report$Year>2019&report$Month==j&report$Gear%in%c("NPT","PTR","TRW"))])
  catz[3,j]=sum(report$Catch..mt.[which(report$Year>2019&report$Month==j&report$Gear=="POT")])
 }}
catz2=rbind(seq(1,12,1),catz)
catz3=t(catz2)

colnames(catz3)=c("Month","Longline","Trawl","Pot")

sumz=colSums(catz3[,2:4])
relz=sumz/sum(sumz)
round(relz,3)#TOtal year

#Winter
sumzW=colSums(catz3[1:4,2:4])
relzW=sumzW/sum(sumzW)
#round(relzW,3)#TOtal year

#nonWinter
sumzNW=colSums(catz3[5:12,2:4])
relzNW=sumzNW/sum(sumzNW)
#round(relzNW,3)#TOtal year

```

There are three predominant gear types in the Aleutian Islands Pacific cod fishery; pot, trawl, and longline, which are implemented at different times of the year (`r figure_nums("catchbygear",display="cite")`). During spawning season (January - April), mature Pacific cod aggregate for spawning at known locations. During these months, over the past 5 years (January 1, 2020 - August 14, 2024), pot and trawl gear were primarily used (`r 100*round(relzW[2],3)`% trawl, `r 100*round(relzW[3],3)`% pot, `r 100*round(relzW[1],3)`% longline). After spawning, Pacific cod typically disperse for feeding (although some do not); during May through December, cod were primarily caught with trawl gear, followed by longline and pot gear (`r 100*round(relzNW[2],3)`% trawl, `r 100*round(relzNW[1],3)`% longline, `r 100*round(relzNW[3],3)`% pot). While the spawning season is approximately half the time of non-spawning (4 vs. 8 months), the majority, `r 100*round(sum(catz3[1:4,2:4])/sum(catz3[,2:4]),3)`%, of the annual catch (during the time period January 1, 2020 - August 14, 2024) took place during spawning season. Catches have exceeded TAC harvest recommendations in five of the nine years since 2013, but have never exceeded the OFL (`r table_nums("catchABC1",display="cite")`). 

CPUE aggregated over gear types for the number and weight of fish show similar trends, indicating that there has been no large shifts in the weight of individual fish (Spies et al. 2023). Recent declines in CPUE may be attributed to the timing of the fishery relative to spawning season or other factors such as hyperaggregation during spawning in the trawl fishery (Rose and Kulka 1999). Standardized surveys are needed to understand whether declines in fishery CPUE represent declines in Aleutian Islands Pacific cod stock size. Recent declines in CPUE may also be due to less effort in targeted Pacific cod fishing. The amount of targeted Pacific cod fishing has decreased since 2018, but the catch in the atka mackerel and rockfish fisheries has remained the same or increased (`r figure_nums("TARGET",display="cite")`, `r table_nums("TARGTAB",display="cite")`).

Length data taken by fishery observers and used in the model (`r table_nums("data_inline",display="cite")`). The number of hauls from which lengths are taken are somewhat proportional to the magnitude of fishing, and the number of hauls which recorded cod lengths was highest in 2001 (`r table_nums("nlens",display="cite")`). 

## Survey Data

The National Marine Fisheries Service (NMFS) conducts biennial daytime summer trawl surveys in the Aleutian Islands. Survey biomass is estimated by extrapolating the weight from individual trawls with the measured path of the trawl area to the total area surveyed. The net used in the Aleutian Islands survey is a high-rise poly-Noreastern 4 seam bottom trawl (27.2 m headrope, 36.8 m footrope, Nichol et al. 2007). Survey biomass estimates and standard error for Pacific cod are available for the survey years 1991, 1994, 1997, 2000, 2002, 2004, 2006, 2010, 2012, 2014, 2016, 2018, and 2022 (`r table_nums("srvbio",display="cite")`). A survey is currently underway during 2024, and a survey biomass estimate will be available for the November assessment. Aleutian Islands surveys prior to 1991 were not used in the model because they were not standardized to current survey methodology; therefore, data from the 1980, 1983, and 1987 surveys were excluded. Survey data includes NMFS areas 541, 542, and 543. The Aleutian Islands bottom trawl survey does include NMFS areas 518 and 519, but these were not included in data for this model because they are not considered part of the Aleutian Islands management area.

Survey age data is available for each survey, 1991-2022. The number of cod aged from the survey has ranged between 500 and 1,200 and the number of hauls ranges from 76-173 (`r table_nums("nages",display="cite")`). Length composition data from the surveys is also used in the model (`r figure_nums("dataSS3",display="cite")`).

The time series of NMFS bottom trawl survey biomass is shown for Areas 541-543 (Eastern, Central, and Western AI, respectively), together with their respective coefficients of variation, in `r table_nums("srvbio1",display="cite")`. These estimates pertain to the Aleutian management area, and so are smaller than the estimates pertaining to the Aleutian survey area that were reported in BSAI Pacific cod stock assessments prior to 2013. Over the long term, the trawl survey biomass data indicate a decline, and the 2022 estimate of biomass is the lowest in the time series. The total biomass estimate for Pacific cod in the Aleutian Islands declined from over 180,000 t in 1991 to 51,539 t in the current year. Recent declines took place in the eastern Aleutians (>50% decline) and in the central Aleutians (32% decline) from the last survey in 2018 to the current survey in 2022. The western Aleutian Islands stock of Pacific cod increased from 11,425 t to 13,661 t (20% increase) between 2018 and 2022 (`r figure_nums("REMA",display="cite")` and `r table_nums("srvbio1",display="cite")`).

The most recent longline survey estimate was also the lowest in the time series, but the longline survey data was not incorporated into the Tier 5 model or the age stuctured models (`r table_nums("srvbio",display="cite")`). The longline survey was designed to target sablefish, and how well it documents the abundance of Pacific cod is uncertain. 

# Analytic Approach [Tier 5 model]

_Model 13.4_

Model 13.4 is the Tier 5 random effects model recommended by the Survey Averaging Working Group, which has been accepted by the Plan Team and SSC since the 2013 assessment for the purpose of setting AI Pacific cod harvest specifications. The Tier 5 random effects model is programmed using the ADMB software package (Fournier et al. 2012) as a “random walk” state-space model.  The only parameter in Model 13.4 is the log of the log-scale process error standard deviation. When used to implement the Tier 5 harvest control rules, the Tier 5 models also require an estimate of the natural mortality rate. The Tier 5 random effects model assumes that the observation error variances are equal to the sampling variances estimated from the haul-by-haul survey data. The log-scale process errors and observations are both assumed to be normally distributed. 

Recent estimates of natural mortality indicate that estimates have ranged from 0.20 to 0.96 for Pacific cod (`r table_nums("M_estimates",display="cite")`). A natural mortality estimate of 0.34 been used in the most recent Aleutian Islands Pacific cod assessment, as well as the 2022 and prior BSAI cod assessments (Thompson et al. 2018). This value was based on Equation 7 of Jensen (1996) and an age at maturity of 4.9 years (Stark 2007). The value of 0.34 adopted in 2007 replaced the value of 0.37 that had been used in all BSAI Pacific cod stock assessments from 1993 through 2006. In response to a request from the SSC, the 2008 assessment included a discussion of alternative values and a justification for the value chosen (Thompson et al. 2008). Using the variance for the age at 50% maturity published by Stark (0.0663), the 95% confidence interval for M extends from about 0.30 to 0.38. The value of 0.34 for natural mortality was used for the `r thisyr` Tier 5 Model 13.4, as in previous years. 

Under Tier 5, $F_{OFL}$ is set equal to the natural mortality, $F_{OFL}$ = M, and the fishing mortality rate to achieve the acceptable biological catch is 75% of M, $F_{ABC}$ $\leq$ 0.75×M.

_Model 24.2_

A new base value for natural mortality, 0.417, was introduced as a base model for age structured models. Therefore, M = 0.417 is presented as an alternative calculation for the Tier 5 reference points in Model 24.2.

# Analytic Approach [Age structured models]

Stock Synthesis Version 3.30.21 was used to run the the age structured models in this assessment. Stock Synthesis requires that prior distributions and initial values be associated with all internally estimated time-invariant parameters. For age structured models presented in this assessment, all parameters were fit freely without informative priors. 

_Data weighting and model tuning_

Survey length and age input sample sizes generated by bootstrapping the number of hauls from which length and age data were taken using the methodology of Hulson et al. (2023). Fishery length composition input sample sizes were based on the number of hauls, and scaled to the mean survey input sample size (so that the mean fishery length composition input sample size was the same as the survey mean input sample size). This did not result in a change in likelihood, but is preferred over a constant sample size approach to weighting compositional data because it considers the number of hauls in each year and therefore the varying informational content in each year. This approach is consistent among the Aleutian Islands, EBS, and GOA Pacific cod assessment models.

The parameter for variance in recruitment, sigmaR, was tuned only once at the end of the model run using a feature in SS3 that provides an estimate based on model output.

Model-based age and length composition data from survey and fishery were weighted using the methodology of Francis (2011) in an iterative process. Input sample sizes for age comps by length bin were equal to the actual number of fish aged in those categories (whole numbers). First, the Variance_adjustment_list was set to all 1’s. Next, Francis weighting was iterated 3 times, with the third estimate used in the model.

*	Input sample sizes for age comps by length bin are equal to the actual number of fish aged in those categories (whole numbers). 
*	The Variance_adjustment_list was set to one for all parameters (fishery lengths, survey lengths, survey ages).
*	Francis weighting performed and iterated 3 times.
*	The marginal compositions were weighted using the bootstrapping method of Hulson et al (2023).

## Description of Alternative Models

We present a series of models to demonstrate the importance of features implemented in 2024 models 24.0 and 24.1 (`r table_nums("TableCompare",display="cite")`). These are bridging models M24.0A tbhrough M24.0G, not intended for consideration as harvest models. Specifically these models evaluated logistic vs. dome-shaped survey selectivity, age plus group, 10+ vs. 13+, estimation of initial fishing mortality during the 10 years prior to the model time series (1981-1990), estimated vs. fixed natural mortality, Richards vs. von Bertalanffy growth curve, a timeblock on M during a heatwave 2016-2023, and a smaller CV on growth at younger ages (`r table_nums("TableCompare",display="cite")`). 

Broad differences among Models 24.0 and 24.1, as well as the bridging models are presented for recruitment (`r figure_nums("Recruitment",display="cite")`), fit to survey index of abundance (`r figure_nums("Index",display="cite")`), and the spawning stock size relative to unfished (`r figure_nums("FracUnfished",display="cite")`)

## Parameters Estimated Outside the Assessment Model

_Maturity_ 

The maturity-at-age is governed by the relationship:

$$Maturity_{age}=\frac{1}{1+e^{-(A+B*age)}},$$ where A and B are parameters in the relationship.

A study based on a collection of 129 female fish in February, 2003, from the Unimak Pass area, NMFS area 509, found that 50% of female fish become mature at approximately 4.88 years ($L_{50\%}$) and 58.0 cm, $A$=-4.7143, $B$=0.9654  (i.e. Tables 2 and 4 in Stark 2007). This maturity ogive is used in the Bering Sea Pacific cod assessment but was not used in this assessment, because the fish in the sample were not from the Aleutian Islands.

Observers routinely collect maturity at length from Pacific cod. An alternative maturity curve was developed based on observer records of maturity from the Aleutian Islands. This parameterization is advantageous because it is based on more records that were taken from Aleutian Islands cod, and is incorporated into age-structured models presented here. Maturity was updated in 2024, resulting in the addition of 24 new visual maturity samples, which did not result in a change to the maturity curve parameters. There were 1,355 records of visual maturity data from the Aleutian Islands (see table below) during the months January – March since 2008. These were used to estimate a maturity ogive by length using the R package _sizeMat_, which estimates the length of fish at gonad maturity. Maturity was considered a binomial response varable and variables were fitted to the logistic function above for maturity, and the length at which 50% of cod are mature is $L_{50\%}=-A/B$. The formula used to fit proportion mature by length was $$Maturity_{length}=\frac{1}{1+e^{-(A+B*length)}}$$ (`r table_nums("maturity",display="cite")`). This method was approved by the Plan Team (September 2022) and SSC (October 2022). Based on this data, the maturity parameters used in the model were A=-8.143, B=0.148, $L_{50\%}$ = 54.9 cm, and slope = -0.148. These data indicate that Aleutian Islands cod mature at smaller sizes than in the Bering Sea.

_Ageing error_

After 2007, there was a shift in our understanding of the first two checks deposited at early ages in Pacific cod. Prior to 2007 they were thought to be true annuli, but subsequently determined not to be. Therefore, geing bias was not incorporated in the model, as all ages used were aged subsequent to 2007, after which time ageing methodology has been consistent and considered non-biased. Ageing error was applied to ages 2-13+. The standard deviation at the first age was 0.57 and 1.16 at the maximum age.

* Age at which the estimated pattern begins (just linear below this age), this is the start age. _The pattern begins at age 3, linear prior to age 3. _
* Bias at start age (as additive offset from unbiased age). _None._
* Bias at maximum (as additive offset from unbiased age). _None._
* Power function coefficient for interpolating between those 2 values (value of 0.0 produces linear interpolation in the bias). _Zero._
* Standard deviation at start age. _0.57_
* Standard deviation at max age. _1.16_
* Power function coefficient for interpolating between those 2 values. _Zero._

There were 10,134 records of aged and lengthed Pacific cod taken from NMFS research surveys between 1991 and 2022 (1991, 1994, 1997, 2000, 2002, 2004, 2006, 2010, 2012, 2014, 2016, 2018, 2022). The maximum age observed was 13 (`r table_nums("ageyr",display="cite")`).

_Natural mortality_

A natural mortality estimate of 0.34 been used in the most recent Aleutian Islands Pacific cod assessment, as well as the 2022 and prior BSAI cod assessments (Thompson et al. 2018). This value was based on Equation 7 of Jensen (1996) and an age at maturity of 4.9 years (Stark 2007). The value of 0.34 adopted in 2007 replaced the value of 0.37 that had been used in all BSAI Pacific cod stock assessments from 1993 through 2006. In response to a request from the SSC, the 2008 assessment included a discussion of alternative values and a justification for the value chosen (Thompson et al. 2008). Using the variance for the age at 50% maturity published by Stark (0.0663), the 95% confidence interval for M extends from about 0.30 to 0.38. 

For the base model, natural mortality was fixed at a value calculated using standard methodology. We used the _Then_lm_ method (http://barefootecologist.com.au/shiny_m.html), which is the same methodology used to calculate natural mortality, M, for the eastern Bering Sea Pacific cod assessment model. The value of M was recalculated for Aleutian Islands Pacific cod to account for different growth patterns and different maximum ages. For example, the maximum age observed in the eastern Bering Sea was 14, while the maximum age observed in the Aleutian Islands was 13. The age data used for this analysis was the same as in the assessment, from all survey years including the most recent survey in 2022 (Table 1). Based on these values, natural mortality M for Aleutian Islands Pacific cod was 0.417. 

The eastern Bering Sea Pacific cod model has moved to a fixed M since 2023. Implementing a fixed value for natural mortality allows for better estimation of parameters that may be constrained by M. For EBS cod, M was calculated as 0.3866. The difference is likely due to faster growth and lower maximum age observed in Aleutian Islands Pacific cod. 

## Parameters Estimated Inside the Assessment Model

While describing parameter estimates, we present results from models 24.0A through 24.0G included to demonstrate the importance of features implemented in 2024 models 24.0 and 24.1 (`r table_nums("TableCompare",display="cite")`). 

_Growth_

The Richards growth curve was used to fit growth within the models, but sensitivity to the von Bertalanffy growth curve is presented (`r table_nums("TableCompare",display="cite")`). The Richards growth curve adds an additional parameter to the logistic growth curve to account for non-symmetrical growth at early ages and maximum ages. Although the Von Bertalanffy growth curve was used in previous iterations of the age structured model, we found that the Richards growth curve improved the fit to the data. The Richards growth curve is also used in the Eastern Bering Sea and the Gulf of Alaska Pacific cod stock assessments. 

The use of the Richards growth curve not only improved the fit to the growth curve but also the likelihood. The addition of the Richards growth curve (vs. von Bertalanffy in M24.0G) allows for an inflection point between younger (age 2) and older cod (age 4+) that is not available in the von Bertalanffy, and provides a better fit to the data. The addition of the full length and age composition data (present in Model 24.0A but not in Models M24.0F and M24.0G) and less uncertainty in younger ages further improved the fit to growth in Model 24.1 (`r figure_nums("Growth",display="cite")`). 

Models presented in 2024 did not incorporate time-varying growth. Pacific cod growth in the Aleutian Islands has not changed significantly throughout the timeseries; therefore, changes in growth over time are not justified. Timeblocks on growth were explored in 2023, but resulted in minimal changes to parameters. 

_Length at age_

Pacific cod do not exhibit sexually dimorphic growth; males and females grow at the same rate. Therefore, the model did not distinguish between males and females. Growth is rapid at younger ages (`r figure_nums("agerainbow",display="cite")`) and was estimated within the model using the Richards growth curve as described above. The selection of age and length bins were important for fitting growth and providing the best fit to the data.

_Selection of maximum age_

The oldest Aleutian Islands cod age observed was 13 years. The 2023 age structured models incorporated 10+ as the maximum age, but we evaluated the use of all observed age classes. Models 24.0B and 24.0D are identical except for the plus group age. Model 24.0B incorporates 13+ and provides a smaller total negative log likelihood than Model 2DB with age plus group 10+. Therefore, models with the full range of observed ages, rather than a truncated age group are preferable. 

_Selection of maximum length_ 

The largest cod observed in the Aleutian Islands was 143 cm, but models presented in 2023 incorporated maximum size class 117+ cm. Model 24.0A used all size classes while Model 24.0B used the 117+ cm plus group (`r table_nums("TableCompare",display="cite")`). The use of all size classes improved the fit to the length composition likelihood component and reduced size of the asymptotic fishery selectivity, 91 cm vs. 95 cm (`r figure_nums("Selectivity",display="cite")`). The use of a maximum size bin set at 117 cm is that the estimation of the length at the maximum age is constrained by the maximum size bin, and cod have grown as large as 143 cm. Therefore, incorporating all observed sizes improves the growth curve and informs the range of Pacific cod sizes present in the population.

_CV on younger ages_

Model 24.0A differs from 24.1 only in the size of the CV on growth on younger ages, and the reduction in total negative log likelihood demonstrates the improved fit to the data (`r table_nums("TableCompare",display="cite")`). We performed a likelihood profile over the CV on younger ages, from 0.1 to the previous value of 0.3, by increments of 0.2. Length data indicated an MLE of 0.16 while age data indicated somewhat lower, 0.14. Francis weighting provided larger weights for age data, so the global estimate was closer to 0.14. The likelihood profile indicated lower CV would be an improvement over 0.3 (`r figure_nums("CV_likeprof",display="cite")`). A value of 0.16 was implemented in Models 24.0 and 24.1, much lower than the previous value. CVs lower than 0.16 were not able to fit the survey length frequencies well because there was some error in the sizes of age 1 and age 2 length frequency. However, the smaller CV at young ages improved the survey selectivity fit to observed length frequencies (`r figure_nums("LengthFit",display="cite")`). 

_Selectivity_

Selectivity for the fishery and the survey were fit (separately) using monotonically increasing asymptotic logistic curve (`r figure_nums("Selectivity",display="cite")`). We considered dome-shaped and logistic survey selectivity as well. Dome shaped survey selectivity was explored because the survey does not collect as many large fish as the fishery. However, it did not improve the fit to the data (Models 24.0B vs. 24.0C) (`r table_nums("TableCompare",display="cite")`). 

_Initial F_

The addition of initial F estimation using mean catch from 1981-1990 improved the fit to the data, as shown in the comparison between Model 24.0D and M24.0E (`r table_nums("TableCompare",display="cite")`). Therefore, initial fishing mortality was incorporated in Models 24.0 and 24.1.

_Natural mortality and time-varying natural mortality_

Model 24.1 used a time block which estimated natural mortality from 2016 - 2024, but it was fixed at M = 0.417 from the beginning of the time series through 2015 (`r table_nums("TableCompare",display="cite")`). The timeblock on natural mortality estimated a single value, rather than a base value with deviations. Estimating a single parameter is advantageous because it reduces the number of parameters estimated and reduces uncertainty.

Model 24.1 accounted for changing environmental conditions due to the shift in temperature through the 2016-2024 time block on natural mortality. The year 2016 was selected because this it is two years after the beginning of the documented thermal shift (Xiao and Ren 2022) (`r figure_nums("Regime",display="cite")`). While this thermal shift has not been documented as an ecological regime shift, it is significant and should be considered as a potential factor for changes in abundance or distribution. The time block did not start earlier because it incorporated a ~two year lag for effects of higher temperatures to be observed, the effect of cumulative stress that increased temperatures can incur (e.g. Barbeaux et al. 2018, Laurel and Rogers 2020). Pacific cod are known to respond poorly to temperatures that exceed their preferred thermal range; therefore, increased natural mortality due to the thermal shift may be the optimal model configuration. The lag also corresponded to the time required for cod to grow to a size/age at first survey selectivity. The assumption that increased natural mortality due to higher temperatures is supported by evidence in the laboratory and in situ, and includes all life stages (Laurel et al. 2008, Barbeaux et al. 2020). Accordingly, the time block on natural mortality in Model 24.1 indicated higher natural mortality which was freely esetimated and not on a bound (`r round(M24_1$Natural_Mortality[34,13],2)`). As of August 2024, heatwave conditions in the Aleutian Islands appear to be less extreme than in past years during all months with the exception of August in the western Aleutians, but periods of moderate heatwave conditions have occurred (`r figure_nums("Heatwave_2024",display="cite")`). 

We allowed Model 24.0F to estimate natural mortality, to examine the ability of the model given the data to estimate this parameter. Model 24.0F estimated M at 0.853 and it improved the overall likelihood. However, whether there is sufficient data in the model to estimate M is uncertain. While M = 0.853 is within the range of natural mortality estimates for Pacific cod (`r table_nums("M_estimates",display="cite")`), it was outside the range of natural mortality recently calculated for Aleutian Islands Pacific cod (beteween 0.3 - 0.5). In addition, Model 24.0F provided multiple aberrant estimates, including a six-fold increase in unfished spawning biomass (`r table_nums("TableCompare",display="cite")`). Therefore, Model 24.0F supports the use of a fixed natural mortality prior to the 2016-2024 time block.

_Catchability_

Literature and previous studies can inform choices for catchability. Somerton (2004) found no evidence for herding in Pacific cod. This experiment took place using the 83-112 Eastern Trawl trawl net in the eastern Bering Sea and the Poly Noreastern trawl net in the Bering Sea (Somerton et al. 2004). Another study estimated that 47.3% of cod in the water column to be available to the trawl used on the eastern Bering Sea trawl survey and 91.6% are available to the trawl used on the Gulf of Alaska and Aleutian Islands surveys (Nichol et al. 2007). This study was based on results showing that 95% of cod were found within 10 m of the seafloor, based on 286 archival tagged cod off Kodiak Island in the Gulf of Alaska and off Unimak Pass in the eastern Bering Sea, Alaska  (Nichol et al. 2007). More recently Rand et al. (2022) found no evidence for difference in mean size of Pacific cod caught by the survey and the fishery in the eastern Bering Sea. However, the Aleutian Islands presents a more complex environment, with rocky and steep habitat that is not consistently trawlable (Logerwell et al. 2005).

A likelihood profile on survey catchability (q) from -0.8 to 0.8 in increments of 0.1 showed that there was insufficient information to inform catchability and multiple conflicts in the data (`r figure_nums("lnQ",display="cite")`). Index data suggested that survey catchability was low (-0.5), and recruitment suggested even lower. In contrast F ballpark indicated very high catchability (0.8). The age and length data were both close to zero, and the MLE was approximately -0.2. Estimating catchability resulted in the scale of the stock increasing to unreasonable proportions, positive recruitment for the entire time series, and Francis weights unreasonably downweighting the data. Therefore, we set the q parameter to be analytical, so that it is no longer treated as a parameter or estimated by the model. The value for catchability used in the model was the exploitable biomass estimated by the model divided by the survey estimate of biomass. This is a common methodology when there is uncertainty in model scale (e.g. https://www.pcouncil.org/documents/2019/10/cowcod-star-panel-report-july-22-26-2019.pdf/). The calculated catchability for Model 24.0 was `r round(M24_0$cpue$Calc_Q[1],3)` and for Model 24.1 was `r round(M24_1$cpue$Calc_Q[1],3)`. 

_Other parameters_

The total likelihood and the number of parameters estimated for each model is shown in `r table_nums("TableCompare",display="cite")`.

## Additional issues that were examined:

*	Steller sea lion pup counts in all three Aleutian Islands NMFS areas.
*	Time blocks are calculated within SS3 with 1 parameter per time block, as opposed to an extra parameter. This results in similar estimates and less uncertainty.
*	Is there significant variation in growth over time to merit a time block on growth parameters (no).
*	Age at settlement. Settlement was fixed to same values as EBS cod (1,1,1,0).
*	Are priors on selectivity needed or justified (no).
*	SR_LN(R0) estimated in phase 1 with no prior, bounds 6 to 12.
*	Is there sufficient information to estimate catchability Q? (no). Selectivity and catchability are confounded.
*	What is the best maximum age (moved from 10 to 13).
*	Is dome shaped fishery selectivity justifiable? (no).
*	Is an asymptotic plus group better? (no)
*	The length of fish (L1) at the early age (0.5 years) was explored at fixed external estimates (but estimated in the final model).
*	All survey data is specified in model as from July, the midpoint of NMFS surveys.
*	Does a timeblock on selectivity last 4 years during the recent period of less targeted fishing improve the model? (not enough data).
*	Do geartypes catch the same size distribution of fish? No all different.
 
# Evaluation of Models and Associated Uncertainty

A Kobe plot demonstrating the stock status uncertainty over $SSB/SSB_{MSY}$ and $F/F_{MSY}$ indicates that the stock has shifted from >$SSB_{MSY}$ in 1991 to a lower stock status <$SSB_{MSY}$. There is currently a 97.6% probability that the stock status is between 0 and $SSB_{35}$, and that the fishing mortality rate is below $F_{40}$% (`r figure_nums("Kobe",display="cite")`). This is consistent with other analyses: `r table_nums("TableCompare",display="cite")` indicates that the proportion of unfished biomass is 22.3%, and fishing mortality has been low relative to management quantities (`r table_nums("catchABC1",display="cite")`, `r figure_nums("catch_gear",display="cite")`).

# Sensitivity to Model Specification

# Likelihood Profiles on Key Parameters
 
Likelihood profiles have been performed on several key parameters, as described above: catchability (`r figure_nums("lnQ",display="cite")`) and the CV on growth for younger ages (`r figure_nums("CV_likeprof",display="cite")`). A likelihood profile on R0, 

A likelihood profile was constructed for initial recruitment (R0) values between 10.4 and 12.0 in increments of 0.2 (`r figure_nums("R0",display="cite")`). The profile suggests that the global MLE for M is at approximately 11.4. Index data indicates that initial recruitment is somewhat higher, while length data indicates initial recruitment is somewhat lower. The global estimate is in the between these two and similar to the recruitment likelihood. 

# Convergence Status and Criteria

# Retrospective analysis 

A ten-year retrospective analysis was conducted by sequential removal of all data annually beginning with 2024 and ending with 2014, for Models 24.0 and 24.1 (`r figure_nums("retro_M2",display="cite")`). By age ten, a cohort of fish have reached their asymptotic length, are considered 100% mature and fully selected by the survey. For Model 24.1, the mean terminal spawning biomass estimate from each of these retrospective models was within the 95% confidence interval of the current base model for the first five years, but deviated as the number of years in the 2016-2024 timeblock was reduced. Retrospective plots for the two age structured models indicate an improved pattern for Model 24.1 over Model 24.0 (`r figure_nums("retro_M2",display="cite")`). 

Hurtado-Ferro (2015) provides some guidance on the range of acceptable values for Mohn's rho. For a flatfish-like species with M = 0.2, the lower and upper bounds were given as -0.15 and 0.2. For a sardine-like species with M = 0.34, the lower and upper bounds were given to be -0.22 and 0.3. If Mohn's rho were entirely dependent on M (likely an oversimplification), then an equation for the lower and upper limits could be developed from these guidelines as follows: 
$Rho_{lowerbound} = -0.08-0.35*M$ and
$Rho_{upperbound} = 0.10+0.50*M$. Using these guidelines, and noting that the base value of natural mortality for Models 24.0 and 24.1 was 0.417, lower and upper bounds would be -0.23 and 0.31. Model 24.0 produced an unacceptable Mohn's rho value, `r Rho_24_0`, while Model 24.1 produced a smaller retrospective pattern, `r Rho_24_1` (`r figure_nums("retro_M2",display="cite")`). Given these guidelines, the Mohn's rho is not outside acceptable bounds for Model 24.1 but it is outside of acceptable values for Model 24.0 (`r figure_nums("retro_M2",display="cite")`).

Without incorporating a timeblock on natural mortality, the model cannot fit recent declines documented by the Aleutian Islands survey. For models without the natural mortality timeblock, such as Model 24.0, the retrospective patterns are outside of acceptable bounds (e.g. Mohn's rho >0.4, `r figure_nums("retro_M2",display="cite")`). 

# Historical retrospectives (between models)

There are no previous age structured models for this stock.

# Tier 5 Model Results

The Tier 5 ABCs and OFLs for `r thisyr+1` and `r thisyr+2` for Model 13.4 are the same as estimated in 2022, due to no new survey data. The 2022 (through 2024) random effect estimates of biomass represent a `r 100*round(1-(Srv_this/Srv_last),2)`% decline from the estimate based on the 2018 Aleutian Islands survey. Model 13.4 incorporates this biomass estimate directly in the calculation of reference points; therefore, the random effects model estimated an exploitable biomass of `r formatC(round(REMA$Biomass[32]),format="d",big.mark=",")` t, which resulted in OFLs (`r T5OFL_thisF` t) and ABCs (`r T5ABC_thisF` t) for `r thisyr+1` and `r thisyr+2`. Model 24.2 calculated Tier 5 ABCs and OFLs with the new estimate of natural mortality calculated using _Then_lm_, M = 0.417, which resulted in higher OFLs (`r T5OFL_thisF24_2` t) and ABCs (`r T5ABC_thisF24_2` t) for `r thisyr+1` and `r thisyr+2`. We recommend the use of age structured models for reference point setting and harvest quantities.

# Age Structured Model Results

Model 24.1 differs from Model 24.0 due to the addition of a time block on natural mortality  with a break in 2015, corresponding with the thermal regime shift in 2013/2014 with a 2-year lag (Xiao and Ren 2022). This results in the best fit to the data and the lowest AIC, and is a significant improvement over model 24.0 (`r table_nums("TableCompare",display="cite")`). Therefore, Model 24.1 was selected as the preferred age structured model and the preferred model for the 2024 Aleutian Islands Pacific cod assessment. Natural mortality was estimated higher in the timeblock as expected due to thermal stress `r round(as.numeric(M24_1$Natural_Mortality[37,23]),3)`, over M = `r round(as.numeric(M24_1$Natural_Mortality[25,23]),3)`. Model 24.1 improved upon Model 24.0 in several likelihood components, including survey and length compositions and survey index (`r  figure_nums("survey_index", display="cite")`, `r  table_nums("TableCompare", display="cite")`). Model 24.1 also produced an acceptable retrospective pattern (`r figure_nums("retro_M2",display="cite")`) and Mohn's rho (`r Rho_24_1`), whereas Model 24.0 did not (M24.0 Mohn's rho = `r Rho_24_0`). Model 24.1 total biomass estimate was `r formatC(M24_1$timeseries$Bio_all[37],format="d",big.mark=",")` t, spawning biomass was `r formatC(Two_year$SSB[1],big.mark=",",format="d")` t, and exploitable biomass was `r formatC(expbio25,big.mark=",",format="d")` t for `r thisyr+1`. Model 24.1 ABCs were `r formatC(Two_year$C_ABC[1],big.mark=",",format="d")` t and `r formatC(Two_year$C_ABC[2],big.mark=",",format="d")` t for `r thisyr+1` and `r thisyr+2`. Model 24.1 OFLs were `r formatC(Two_year$C_OFL[1],big.mark=",",format="d")` t and `r formatC(Two_year$C_OFL[2],big.mark=",",format="d")` t for `r thisyr+1` and `r thisyr+2`. 

Projections for Aleutian Islands Pacific cod 2025 through 2037 based on the seven harvest scenarios are shown as figures for Model 24.1 for catches (`r figure_nums("Catch_scenarios",display="cite")`) and for stock status (`r figure_nums("Projection_scenarios",display="cite")`.


\pagebreak

# Acknowledgements

We thank the survey scientists and crew from National Marine Fisheries Service Aleutian Islands surveys.

# Literature Cited

Barbeaux, S., K. Aydin, B. Fissel, K. Holsman, B. Laurel, W. Palsson, K. Shotwell, Q. Yang, and S. Zador.  2018.  Assessment of the Pacific cod stock in the Gulf of Alaska.  In Plan Team for Groundfish Fisheries of the Gulf of Alaska (compiler), Stock assessment and fishery evaluation report for the groundfish resources of the Gulf of Alaska, chapter 2, p. 1-160.  North Pacific Fishery Management Council, 605 W. 4th Avenue Suite 306, Anchorage, AK 99501.

Barbeaux, S.J., Holsman, K. and Zador, S., 2020. Marine heatwave stress test of ecosystem-based fisheries management in the Gulf of Alaska Pacific Cod Fishery. Frontiers in Marine Science, 7, p.703.

Hurtado-Ferro, F., C. S. Szuwalski, J. L. Valero, S. C. Anderson, C. J. Cunningham, K. F. Johnson, R. Licandeo, C. R. McGilliard, C. C. Monnahan, M. L. Muradian, K. Ono, K. A. Vert-Pre, A. R. Whitten, and A. E. Punt.  2015.  Looking in the rear-view mirror: bias and retrospective patterns in integrated, age-structured stock assessment models.  ICES Journal of Marine Science 72:99-110.

Jensen, A. L.  1996.  Beverton and Holt life history invariants result from optimal trade-off of reproduction and survival.  Can. J. Fish. Aquat. Sci. 53:820-822.

Laurel, B.J., and L. A. Rogers. 2020. Loss of spawning habitat and prerecruits of Pacific cod during a Gulf of Alaska heatwave. Canadian Journal of Fisheries and Aquatic Sciences. 77(4): 644-650. https://doi.org/10.1139/cjfas-2019-0238.

Logerwell, E.A., Aydin, K., Barbeaux, S., Brown, E., Conners, M.E., Lowe, S., Orr, J.W., Ortiz, I., Reuter, R. and Spencer, P., 2005. Geographic patterns in the demersal ichthyofauna of the Aleutian Islands. Fisheries Oceanography, 14, pp.93-112.

Nichol, D. G., T. Honkalehto, G. G. Thompson.  2007.  Proximity of Pacific cod to the sea floor: using archival tags to estimate fish availability to research bottom trawls.  Fisheries Research 86:129-135.

Rand, K.M., McDermott, S.F., Bryan, D., Nielsen, J.K., Spies, I.B., Barbeaux, S.J., Loomis, T. and Gauvin, J., 2022. Non-random fishery data can validate research survey observations of Pacific cod (_Gadus macrocephalus_) size in the Bering Sea. Polar Biology, pp.1-10.

Somerton, D.A., 2004. Do Pacific cod (Gadus macrocephalus) and walleye pollock (_Theregra chalcogramma_) lack a herding response to the doors, bridles, and mudclouds of survey trawls?. ICES Journal of Marine Science, 61(7), pp.1186-1189.

Stark, J. W.  2007.  Geographic and seasonal variations in maturation and growth of female Pacific cod (_Gadus macrocephalus_) in the Gulf of Alaska and Bering Sea.  Fish. Bull. 105:396-407.

Thompson, G., J. Ianelli, R. Lauth, S. Gaichas, and K. Aydin.  2008.  Assessment of the Pacific cod stock in the Eastern Bering Sea and Aleutian Islands Area.  In Plan Team for Groundfish Fisheries of the Bering Sea/Aleutian Islands (compiler), Stock assessment and fishery evaluation report for the groundfish resources of the Bering Sea/Aleutian Islands regions, p. 221-401.  North Pacific Fishery Management Council, 605 W. 4th Avenue Suite 306, Anchorage, AK 99501.

Thompson, G. G., and W. A. Palsson.  2018.  Assessment of the Pacific cod stock in the Aleutian Islands.  In Plan Team for Groundfish Fisheries of the Bering Sea/Aleutian Islands (compiler), Stock assessment and fishery evaluation report for the groundfish resources of the Bering Sea/Aleutian Islands regions, chapter 2, p. 1-48.  North Pacific Fishery Management Council, 605 W. 4th Avenue Suite 306, Anchorage, AK 99501.

Xiao, D., and Ren, H.L. 2022. A regime shift in North Pacific annual mean sea surface temperature in 2013/14. Front. Earth Sci. doi.org/10.3389/feart.2022.987349.


# Tables

`r table_nums(name="TableCompare", caption = " Comparison of likelihoods and model parameters among Models 24.0, 24.1, and six bridging models, M24.0A, M24.0B, M24.0C, M24.0D, M24.0E, M24.0F, and M24.0G. Upper portion describes the features in each mode, with X demarcating features in the 2024 model and 0 representing alternative features or features found in the 2023 model. The likelihood components, derived quantities, and parameter estimates for each model are shown below Results.")`
\
``` {r TableCompare, echo=FALSE, message=FALSE}

TableCompare=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/data/TableComparisons1.csv",header=FALSE)
colnames(TableCompare)=c("Features","M24.1","M24.0","M24_0A","M24_0B","M24_0C","M24_0D","M24_0E","M24_0F","M24_0G")
TableCompare[1,2:10]=""
kable(TableCompare,"latex",linesep="",longtable=FALSE,align="l",digits=0)%>%
  kable_styling(font_size = 7.5, position="left")%>%row_spec(11,hline_after=T, extra_latex_after = "%")%>%row_spec(10,hline_after=T, extra_latex_after = "%")%>%row_spec(1,hline_after=T, extra_latex_after = "%")%>%row_spec(9,hline_after=T, extra_latex_after = "%")

#kable(TARGmatr2,"latex",linesep="",longtable=FALSE,align='l')%>%add_header_above(c("Year"=1,"Non-target"=7,"Target"=1,"Overall"=1))%>%kable_styling(font_size = 8)

```



\pagebreak


`r table_nums(name = "Tier5_comparison", caption = " Summary table with a comparison of Models 13.4 and 24.2. M represents natural mortality rate. Note the 2024 accepted ABC and OFL were adjusted from the 2024 model values for OFL and ABC.")`

``` {r Tier5_comparison, echo=FALSE, message=FALSE}

```

\begin{table}[ht]
\centering
\begin{tabular}{lrr|rr|rr}
  \hline
       & \multicolumn{2}{c|}{Model 13.4 } &\multicolumn{2}{c|}{Model 13.4 } & \multicolumn{2}{c}{Model 24.2 }  \\
       & \multicolumn{2}{c|}{As estimated or $\mathit{specified}$ } & \multicolumn{2}{c}{As estimated or $\mathit{recommended}$} &  \multicolumn{2}{c}{As estimated or $\mathit{recommended}$ }  \\
       & \multicolumn{2}{c|}{$\mathit{last}$ year for:}  & \multicolumn{2}{c}{$\mathit{this}$ year for: }  & \multicolumn{2}{c}{$\mathit{this}$ year for: }               \\
        Quantity & `r thisyr`      &`r thisyr+1`   & `r thisyr+1`      &`r thisyr+2`& `r thisyr+1`      &`r thisyr+2` \\ 
  \hline
	$M$ 	&	0.34	&	0.34	&	0.34	&	0.34 & 0.417 & 0.417 \\
Tier	&	5	&	5	&	5	&	5 &	5	&	5 \\
Biomass (t)	& `r T5TotBio_lastF` & `r T5TotBio_lastF` & `r T5TotBio_thisF` & `r T5TotBio_nextF` & `r T5TotBio_thisF` & `r T5TotBio_nextF`  \\
$F_{OFL}$    	&	0.34	&	0.34 	&	0.34	&	0.34	&	0.417	&	0.417	\\
$maxF_{ABC}$   	&	0.255	&	0.255	&	0.255	&	0.255 &	0.313	&	0.313  	\\
$F_{ABC}$       &	0.255	&	0.255	&	0.255	&	0.255 &	0.313	&	0.313        \\
$OFL$    	      & `r T5OFL_2024`  & `r T5OFL_2024`  & `r T5OFL_thisF`  & `r T5OFL_thisF`  & `r T5OFL_thisF24_2`  & `r T5OFL_thisF24_2`    \\
$maxABC$    	  & `r T5ABC_2024` & `r T5ABC_2024` & `r T5ABC_thisF` & `r T5ABC_thisF`  & `r T5ABC_thisF24_2` & `r T5ABC_thisF24_2`\\
$ABC$ 	       & `r T5ABC_2024` & `r T5ABC_2024` & `r T5ABC_thisF` & `r T5ABC_thisF` & `r T5ABC_thisF24_2` & `r T5ABC_thisF24_2`      \\
\hline
Status	                              &	`r thisyr-2`	      &	 `r thisyr-1`	      &		`r thisyr-1`             &	`r thisyr` &		`r thisyr-1`             &	`r thisyr`          \\
\hline
Overfishing	                          &	No	        &	n/a	      &	No	                       &	n/a  &	No	                       &	n/a                 \\
\hline
\end{tabular}
\end{table}



\pagebreak

`r table_nums(name = "data_inline", caption = " Sources of data used in the age structured models, Model 24.0 and 24.1. *Data current through August 15, 2024.")`


```{r data_inline, echo=FALSE,message=FALSE}
data_inline=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/data_inline.csv",header=TRUE)

kable(data_inline[1:6,],"latex",linesep="",align='l')%>%kable_styling(latex_options="scale_down")%>%kable_styling(latex_options="hold_position")

#kable(hist,col.names=c("Year","Foreign","Joint Venture","Domestic","Total"),"latex",booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=5)))

```

\pagebreak



`r table_nums(name = "srvbio1", caption = " Aleutian Islands bottom trawl survey biomass estimates and standard error by NMFS area for Pacific cod, for all years used in the model.")`
``` {r srvbio1, echo=FALSE,message=FALSE}

#AKFIN biomass by NMFS reporting area
#Srv_bio2=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2023/AI_survey_cod_NMFSarea.csv",header=TRUE)
#yrs=names(table(Srv_bio2$Year))
#area=names(table(Srv_bio2$NMFS.Reporting.Area))
#area2=c("Western Aleutians","Central Aleutians","Eastern Aleutians")
#Srv_bio2mat=matrix(0,length(yrs),3)
#Srv_bio2var=matrix(0,length(yrs),3)
#for (i in 1: length(yrs)){
#  for(j in 1: length(area)){
#    Srv_bio2mat[i,j]=sum(Srv_bio2$Area.Biomass[which(Srv_bio2$Year==yrs[i]&Srv_bio2$NMFS.Reporting.Area==area2[j])])
#    Srv_bio2var[i,j]=sum(Srv_bio2$Area.Biomass.Var[which(Srv_bio2$Year==yrs[i]&Srv_bio2$NMFS.Reporting.Area==area2[j])],na.rm=TRUE)
#      }
#}

#CV=format(sqrt(Srv_bio2var)/Srv_bio2mat,digits=2)

#Srv_bio3=formatC(cbind(yrs,formatC(round(cbind(Srv_bio2mat,rowS#ums(Srv_bio2mat))), format="d", big.mark=",")),drop0trailing = #FALSE)
#colnames(Srv_bio3)=c("Year",c("Western","Central","Eastern","Total"))    

#propS=format(Srv_bio2mat/rowSums(Srv_bio2mat),digits=3)

#Srv_bio4=cbind(yrs,propS,rep("1.000",length(yrs)))
#colnames(Srv_bio4)=c("Year",c("Western","Central","Eastern","Total"))

#Srv_bio5=formatC(cbind(yrs,CV,format(sqrt(rowSums(Srv_bio2var))/rowSums(Srv_bio2mat),digits=3)),drop0trailing = FALSE)
#colnames(Srv_bio5)=c("Year",c("Western","Central","Eastern","Total"))

#write.csv(Srv_bio3,"/Users/ingridspies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/Srv_bio3.csv")
#write.csv(Srv_bio4,"/Users/ingridspies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/Srv_bio4.csv")
#write.csv(Srv_bio5,"/Users/ingridspies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/Srv_bio5.csv")

Srv_bio3=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2023/Srv_bio3.csv",header=TRUE)
Srv_bio4=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2023/Srv_bio4.csv",header=TRUE)
Srv_bio5=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2023/Srv_bio5.csv",header=TRUE)

#here is how to get SE for SS input file
#sqrt(log(1+as.numeric(Srv_bio5[,5])^2))

kable(Srv_bio3[,2:6],"latex",booktabs=T,linesep="",longtable=FALSE,align="r")%>%add_header_above(c("Biomass (t)"=4),line=FALSE,align="l")

kable(Srv_bio4[,2:6],"latex",booktabs=T,linesep="",longtable=FALSE,align="r")%>%add_header_above(c("Proportion by area"=4),line=FALSE,align="l")

# formatC(Srv_bio5,drop0trailing = TRUE,digits=3),
kable(Srv_bio5[,2:6],"latex",booktabs=T,linesep="",longtable=FALSE,align="r",digits=3)%>%add_header_above(c("Biomass coefficient of variation"=4),line=FALSE,align="l")


``` 



\pagebreak

`r table_nums(name = "catchABC1", caption = paste(" Pacific cod catch in metric tons by year, total allowable catch (TAC), acceptable biological catch (ABC), and overfishing limit (OFL), 1991-",thisyr,". Note that specifications were combined for the Bering Sea and Aleutian Islands cod stocks through 2013 and are shown for the Aleutian Islands alone for 2013 onwards. Catch for ",thisyr," is through August 14. ABC, OFL, and TAC for ", thisyr ," are based on last year's model output.",sep=""))`
``` {r catchABC1, echo=FALSE,message=FALSE}


Fish_catch_ABCOFL=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Fish_catch_ABCOFL.csv",header=TRUE)


kable(Fish_catch_ABCOFL[,1:5],col.names=c("Year","Catch (t)","ABC","TAC","OFL"),"latex",booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=5)))%>%row_spec(23,hline_after=T, extra_latex_after = "%")
``` 

\pagebreak

\pagebreak



`r table_nums(name = "TARGTAB", caption = " Catch of Pacific cod from 1993-2024 in non-target and targeted fisheries, as of August 14, 2024.")`
```{r TARGTAB, echo=FALSE, message=FALSE}


#TARG=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Groundfish Total Catch by Fishery_ALL_TARGETS_8_14_24.csv",header=TRUE)
#Target=names(table(TARG$Trip.Target.Group))
#Yrs=as.numeric(names(table(TARG$Year)))
#TARGmat=matrix(0,length(Yrs),length(Target))

#for(i in 1:length(Target)){
#  for(j in 1:length(Yrs)){
#    TARGmat[j,i]=round(sum(TARG$Catch..mt.[which(TARG$Year==Yrs[j]&TARG$Trip.Target.Group==Target[i])]))
#  }
#}
#rownames(TARGmat)=Yrs
#colnames(TARGmat)=Target

#TARGmat[,5]=TARGmat[,4]+TARGmat[,5]
#TARGmat=TARGmat[,c(1,2,3,5,6,7,8,9)]
#write.csv(TARGmat,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/TARGMAT.csv")

#TARGmat1=reshape2::melt(TARGmat,value.name="Year")
#colnames(TARGmat1)=c("Year","Target","Value")
#write.csv(TARGmat1,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/TARGMAT1.csv")

TARGmat=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/TARGMAT.csv")
TARGmat$Total=rowSums(TARGmat[,2:9])
TARGmat$NonTarget=rowSums(TARGmat[,2:9])-TARGmat[,6]
TARGmatr=TARGmat[,c(2,3,4,7,8,5,11,6,10)]


TARGmatr2=sapply(TARGmatr,formatC,big.mark=",",format="d")
rownames(TARGmatr2)=seq(1993,2024,1)
colnames(TARGmatr2)=c("Atka\nmackerel","Flatfish","Halibut","Pollock","Rockfish","Other","Total\nnon-target","Pacific\ncod","Total")

kable(TARGmatr2,"latex",linesep="",longtable=FALSE,align='l')%>%add_header_above(c("Year"=1,"Non-target"=7,"Target"=1,"Overall"=1))%>%kable_styling(latex_options = "hold_position")%>%
  kable_styling(font_size = 8)

```





\pagebreak




\pagebreak

`r table_nums(name="nlens", caption = " The number of hauls in which length observations were taken for the fishery and survey length composition data, by year.")`

``` {r nlens, echo=FALSE, message=FALSE}
#Nsamp used in model
len_8_24=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Pcod_adjusted_fishlengthdata_8_24_24.csv",header=TRUE)

haulz=vector()
yrs=seq(1991,2024,1)
for (i in 1:length(yrs)){
haulz[i]=length(table(len_8_24$Haul.Join[which(len_8_24$Year==yrs[i])]))  
}
fish_hauls_yr=cbind(yrs,haulz)
colnames(fish_hauls_yr)=c("Year","number_hauls")

options(knitr.kable.NA = "-")
kable(fish_hauls_yr,"latex",booktabs=T,linesep="",longtable=FALSE,align="r",digits=0)

``` 



\pagebreak



`r table_nums(name = "srvbio", caption = " Aleutian Islands bottom trawl biomass estimates (t) and longline survey relative population numbers and standard error for Pacific cod, for all years used in the models.")`
``` {r srvbio, echo=FALSE,message=FALSE}

#mods1 <- SS_output("/Users/ingridspies/admbmodels/AI_Pcod/2022_SS/AI_Pcod-SS/Stock_Synthesis_files/M22_1/",verbose=FALSE,printstats=FALSE)

#srvbio=cbind(
#mods1$cpue$Yr[which(mods1$cpue$Fleet_name=="Srv")], #mods1$cpue$Obs[which(mods1$cpue$Fleet_name=="Srv")], #mods1$cpue$SE_input[which(mods1$cpue$Fleet_name=="Srv")],
#mods1$cpue$Obs[which(mods1$cpue$Fleet_name=="LLSrv")],
#mods1$cpue$SE_input[which(mods1$cpue$Fleet_name=="LLSrv")])
#srvbio=data.frame(srvbio)
#srvbio=data.frame(srvbio)
#srvbio$X2=formatC(srvbio$X2,format="d",big.mark=",")
#srvbio$X2=na_if(srvbio$X2,"")
#srvbio$X4=formatC(srvbio$X4,format="d",big.mark=",")
#srvbio$X4=na_if(srvbio$X4,"")
#srvbio$X3=round(srvbio$X3,3)
#srvbio$X5=round(srvbio$X5,3)

#srvbio <- replace(srvbio, is.na(srvbio), "")
#srvbio=set_na(srvbio, na = c(var1 = 1.0, var2 = 1.0000000))
#srvbio <- replace(srvbio, is.na(srvbio), "")

#srvbio=set_na(srvbio, na = c(var1 = 1.0, var2 = 1.000))
#write.csv(srvbio,"/Users/ingridspies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/srvbio.csv")
#I removed 1s by hand
srvbio=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2023/srvbio.csv",header=TRUE)


colnames(srvbio)=c("X","Year","Biomass (t)","S.E.","Index","S.E. ")

options(knitr.kable.NA = "-")


kable(srvbio[,2:6],"latex",booktabs=T,linesep="",longtable=FALSE,align="r",digits=3)%>%add_header_above(c(" "=1,"Trawl Survey"=2,"Longline Survey"=2),line=FALSE,align="l")


``` 


\pagebreak


`r table_nums(name="nages", caption = " Survey age composition sample size data, by year, including the number of individual fish, number of hauls, and effective sample size for each year. Effective sample sizes were generated using the methodology of Hulson et al (2023).")`

``` {r nages, echo=FALSE, message=FALSE}
#Nsamp used in model
#Pete Hulson calculated effective size
nhauls_age3=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/nhauls_age3.csv",header=TRUE)
colnames(nhauls_age3)=c("Year","Number of aged fish","Number of hauls","Effective sample size")

#Use GET_DOM_AGE.r to find out how many ages in each fishery
#geartype=1 is NPT non pelagic trawl
#gertype=2 is Pelagic Trawl 
#6 pot
#7 jig
#8 longline
#2020 trawl=6,pot=46,ll=194
#2021 ll=165,pot=31
options(knitr.kable.NA = "-")
kable(nhauls_age3[,],"latex",booktabs=T,linesep="",longtable=FALSE,align="r",digits=0)

``` 

\pagebreak


`r table_nums(name="M_estimates",caption=" Estimates of natural mortality, M, for Pacific cod throughout their range. Values marked with asterisks * have been used in stock assessments.")`
```{r M_estimates,echo=FALSE,message=FALSE}
Mest=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/M_estimates_stats2.csv",header=TRUE)

Mest1=data.frame(Mest)
colnames(Mest1)=c("Region","Reference Author","Year","M estimate")

kable(Mest1[,1:4],format="latex",booktabs=T,linesep="")%>%kable_styling(latex_options = "hold_position")



```


\pagebreak



`r table_nums(name = "maturity", caption = " Maturity at age ogives based on histological data (Stark 2007) and observer maturity at length data (visual observation) from 2008-2021 (1331 records), and updated for this assessment with data from 2008-2024 (1355 records). Observer-based maturity curves were used in age structured models.")`
``` {r maturity, echo=FALSE,message=FALSE}

#library(data.table)
#library(sizeMat)

##data_old<-data.table(read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/codmaturity_9_20_2021.csv"))
##data=data_old

#data<-data.table(read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/CodMaturity_8_14_24.csv"))
#dataAI<-data[NMFS_AREA%in%c(540:544)] 
#dataAI120<-dataAI[MONTH<=4&YEAR>2007&SEX=='F']   ## Restrict it to beginning of the year and years 2008-2019
#Lengths are for January, Feb, March
#1355 records (old was 1331 records)

#my_ogive_fq = gonad_mature(dataAI120,varNames = c("LENGTH", "MATURITY_DESCRIPTION"), inmName = "Immature",matName = c("Pre Spawn","Spawning","Spent","Developing","Resting" ), method = "bayes", niter = 999)

#length=seq(4,143,1)
#A=median(my_ogive_fq$A_boot)
#B=median(my_ogive_fq$B_boot)

#source("/Users/ingrid.spies/Documents/AI_PCOD/2024/R/read-admb.R")
#AI=read_rep("/Users/ingrid.spies/Documents/admbmodels/AI_Pcod/2021/AI_Pcod_1fishsel_2021.rep") #stark Model 19.0b


#2021 (1331 records)
#A=-8.084672; B=0.1471665
#mat_est21=(1/(1+exp(-(A + B*length))));
#mat_estAGE21=AI$lenage%*%mat_est

#2024 (1355 records)
#A=-8.143064;B=0.1483235
#mat_est24=(1/(1+exp(-(A + B*length))));
#mat_estAGE24=AI$lenage%*%mat_est

#In the SS3 model, 50% maturity at length is -A/B and the slope is -B!
#So for 2024,  
#-A/B 54.9007. 50% maturity
#-B -0.1483235 slope.

#Stark
#Ajs=-4.7143;Bjs=0.9654;
#mat_estSTARK=(1/(1+exp(-(Ajs + Bjs*(seq(1,10,1))))));

#matx=cbind(seq(1,10,1),mat_estSTARK,mat_estAGE21,mat_estAGE24)
#colnames(matx)=c("Age","Stark 2007","Observer data 2021","Observer data 2024")

#write.csv(matx,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/matx.csv")
matx=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/matx.csv",header=TRUE)

kable(matx[,2:5],col.names=c("Age","Stark 2007","Observer 2021","Observer 2024"),"latex",booktabs=T,linesep="",longtable=FALSE,digits=3)
``` 
\pagebreak

`r table_nums(name="ageyr",caption=" Number of Pacific cod observed in otolith collections by age and year.")`

```{r ageyr,echo=FALSE,message=FALSE}
ageyr=read.csv("/Users/ingrid.spies/Documents/AI_PCOD/2024/AIPcod2024/Ageyr.csv",header=TRUE)
ageyr1=ageyr[,2:14]
rownames(ageyr1)=ageyr[,1]
colnames(ageyr1)=seq(1,13,1)

kable(ageyr1,"latex",booktabs=T,linesep="",longtable=FALSE)

```

\pagebreak



`r table_nums(name="catch_AI",caption = paste(" Summary of 1994-2024 catches (t) of Pacific cod in the AI, by NMFS statistical area (area breakdowns not available prior to 1994).  Catches for ",thisyr,"are through August 14."))`

```{r catch_AI,echo=FALSE, message=FALSE}
#setu p for catch_AI table
catAI=cat24

yrs=names(table(catAI$Year))
catAI1=matrix(0,length(yrs),6)
areas=c(543,542,541)
for(i in 1:length(yrs)){
  for(j in 1:3){
      catAI1[i,j]=sum(catAI$Catch..mt.[which(catAI$Year==yrs[i]&catAI$NMFS.Area==areas[j])])
  }
}
rownames(catAI1)=yrs
colnames(catAI1)=c(areas,areas)

tots=rowSums(catAI1)


catAI1[,4]=format(catAI1[,1]/tots,digits=1)
catAI1[,5]=format(as.numeric(catAI1[,2])/tots,digits=2)
catAI1[,6]=format(as.numeric(catAI1[,3])/tots,digits=3)
catAI1[,1]=formatC(round(as.numeric(catAI1[,1])),format="d",big.mark=",")
catAI1[,2]=formatC(round(as.numeric(catAI1[,2])),format="d",big.mark=",")
catAI1[,3]=formatC(round(as.numeric(catAI1[,3])),format="d",big.mark=",")

catAIplot=reshape2::melt(catAI1)
colnames(catAIplot)=c("Year","Area","Catch")
catAIplot2=catAIplot[1:99,]
#ggplot(data=catAIplot2)+geom_line(aes(x=Year,y=Catch,color=as.factor(Area)),lwd=1.5)+theme_bw()+ggtitle("Catch of Pacific cod by year in the Aleutian Islands")

kable(catAI1[4:nrow(catAI1),],col.names=c("Western","Central","Eastern","Western","Central","Eastern"),"latex",booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=6)))%>%add_header_above(c("Year","Total Catch"=3,"Proportions"=3))

```


\pagebreak


`r table_nums(name="retdis",caption = paste0(" Discards (t) and discard rates for Pacific cod caught in the Aleutian Islands, for the period 1993 - August 14, ",thisyr,". Note that Amendment 49, which mandated increased retention and utilization, was implemented in 1998."))`

```{r retdis,echo=FALSE, message=FALSE}
#retained discarded in groundfish total discards and do not select a target fishery
#retdis=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/GroundfishTotalDiscardsAICod_Aug14_1991_2024.csv",header=TRUE)

#yrs=names(table(retdis$Year))
#tretdis=matrix(0,length(yrs),4)
#for(i in 1:length(yrs)){
#  tretdis[i,1]=yrs[i]
#  tretdis[i,2]=round(sum(retdis$Discards..mt.[which(retdis$Year==yrs[i])]))
#   tretdis[i,3]=round(sum(retdis$Total.Catch..mt.[which(retdis$Year==yrs[i])]))
#    tretdis[i,4]=as.numeric(tretdis[i,2])/as.numeric(tretdis[i,3])
#}

#tretdis1=data.frame(cbind(yrs,formatC(as.numeric(tretdis[,2]),format="d",big.mark = ","),formatC(as.numeric(tretdis[,3]),format="d",big.mark = ","),formatC(as.numeric(tretdis[,4]),format="f",digits=3)))

#write.csv(tretdis1,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/tretdis1.csv")

tretdis1=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/tretdis1.csv",header=TRUE)
kable(tretdis1[,2:5],col.names=c("Year","Discards (t)","Total catch (t)","Proportion discarded"),booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=4)))

thisyr=2024
```



\pagebreak

`r table_nums(name = "catch81_90", caption = " Summary of catches of Pacific cod (t) in the Aleutian Islands by gear type. All catches include discards. Domestic annual catch by gear is not available prior to 1988.")`

``` {r catch81_90, echo=FALSE,message=FALSE}
catch81_90=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Catch_1981_1990.csv",header=TRUE)
kable(catch81_90,col.names=c(" ","Trawl","Longline","Total","Trawl","Trawl","Longline and pot","Total",""),"latex",booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=9)))%>%add_header_above(c("Year"=1,"Foreign"=3,"Joint Venture"=1,"Domestic"=3,"Total"=1))
``` 


\pagebreak

`r table_nums(name="Fish_catch",caption = paste(" Federal and state fishery Pacific cod catch in metric tons by year, 1991-",thisyr,". To avoid confidentiality problems, federal longline and pot catches have been combined. “Other” gear types include gill net and jig. Catches for ",thisyr," are through August 14. The state fishery catch is included in the total, and broken out as a separate column from 2006 onward.",sep=""))`

``` {r Fish_catch, echo=FALSE, message=FALSE}
#AKFIN Analyst specific reports Thompson PCod catch by juristictoin.

fish_catch$Trawl=formatC(fish_catch$Trawl,big.mark=",",format="d")
fish_catch$Longline.Pot.Catch=fish_catch$Longline+fish_catch$Pot
fish_catch$Longline.Pot.Catch=formatC(fish_catch$Longline.Pot.Catch,big.mark=",",format="d")
fish_catch$Other=formatC(fish_catch$Other,big.mark=",",format="d")
fish_catch$Total=formatC(fish_catch$Total,big.mark=",",format="d")
fish_catch2=data.frame(seq(1991,2024,1),fish_catch$Trawl,fish_catch$Longline.Pot.Catch,fish_catch$Other,fish_catch$Total,c(rep(0,5),formatC(cgearSTATE,big.mark = ",",format="d")))
colnames(fish_catch2)=c("Year","Trawl","Longline+Pot","Other","Total","State")
#I used the report file to fill in the fish_catch1 file.
kable(fish_catch2,"latex",booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=6)))
#col.names=c(" ","Trawl","Longline+Pot","Other","Total"," ").  %>%add_header_above(c("Year"=1,"Gear"=3,"Total"=1))

```


\pagebreak

\pagebreak





`r table_nums(name = "histcatch", caption = " Catch of Pacific cod in the Aleutian Islands by foreign, domestic, and joint venture fisheries, 1964-1980. Note that joint venture fisheries did not commence until 1981, and domestic catch information is not available prior to 1988.")`

``` {r histcatch, echo=FALSE,message=FALSE}
hist=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/AIcatch_1964_1980.csv",header=TRUE)

kable(hist,col.names=c("Year","Foreign","Joint Venture","Domestic","Total"),"latex",booktabs=T,linesep="",longtable=FALSE,align=c(rep('r',times=5)))
``` 

\pagebreak




# Figures





```{r survey_index,echo=FALSE,message=FALSE}

```


\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_0/run/plots/index2_cpuefit_Srv.png}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/plots/index2_cpuefit_Srv.png}

`r figure_nums(name = "survey_index", caption = " Model 24.0 (upper panel) and Model 24.1 (lower panel) fit to survey index, 1991 - 2024.")`

\end{center}

\pagebreak



```{r retro_M2,echo=FALSE,message=FALSE}


```



\begin{center}
\includegraphics[width=4in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_0/run/retrospectives2/Retro_Uncertainty.pdf}
\includegraphics[width=4in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/retrospectives/Retro_Uncertainty.pdf}
\end{center}

`r figure_nums(name = "retro_M2", caption = " Retrospective plot of spawning biomass, Model 24.0 (upper panel), and Model 24.1 (lower panel).")`

\pagebreak





```{r dataSS3,echo=FALSE,message=FALSE}
dataSS3 <-  rasterGrob(as.raster(readPNG("/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/plots/data_plot2.png"), interpolate = FALSE))

grid.arrange(dataSS3)


```

`r figure_nums(name = "dataSS3", caption = " Data sources and relative weight used in Models 24.0 and 24.1.")`

\pagebreak

\pagebreak

```{r catch_gear, echo=FALSE,message=FALSE}


yrs=names(table(report$Year))
state=vector()
fed_trawl=vector()
fed_LLPOT=vector()
fed_POT=vector()
fed_LL=vector()
TOT=vector()
for(i in 1:length(yrs)){
  state[i]=sum(report$Catch..mt.[which(report$Year==yrs[i]&report$State.Federal.Fishery=="S")])
  fed_trawl[i]=sum(report$Catch..mt.[which(report$Year==yrs[i]&report$State.Federal.Fishery=="F"&report$Gear!="POT"&report$Gear!="HAL")])
  fed_LLPOT[i]=sum(report$Catch..mt.[which(report$Year==yrs[i]&report$State.Federal.Fishery=="F"&report$Gear%in%c("POT","HAL"))])
  fed_LL[i]=sum(report$Catch..mt.[which(report$Year==yrs[i]&report$State.Federal.Fishery=="F"&report$Gear=="HAL")])
  fed_POT[i]=sum(report$Catch..mt.[which(report$Year==yrs[i]&report$State.Federal.Fishery=="F"&report$Gear=="POT")])
  TOT[i]=sum(report$Catch..mt.[which(report$Year==yrs[i])])
}

#catch_gr1=cbind(yrs,state,fed_trawl,fed_LL,fed_POT)
catch_gr1=as.data.frame(cbind(rep(yrs,5),c(state,fed_trawl,fed_LL,fed_POT,TOT),c(rep("State",length(yrs)),rep("Trawl",length(yrs)),rep("Longline",length(yrs)),rep("Pot",length(yrs)),rep("TOTAL",length(yrs)))))
colnames(catch_gr1)=c("Year","Catch","Gear")
catch_gr1$Catch=as.numeric(catch_gr1$Catch)
catch_gr1$Gear=as.factor(catch_gr1$Gear)
catch_gr1$Year=as.numeric(catch_gr1$Year)

ggplot(catch_gr1)+geom_line(aes(x=Year,y=Catch,color=Gear))+theme_few()+geom_point(aes(x=2024,y=12431),color="blue")+ylab("Catch (t)")

#could add the M24.1 ABC geom_point(aes(x=2024,y=M24_1_Two_Year$C_ABC[1]),color="red")+geom_vline(xintercept = 2024)




```
`r figure_nums(name = "catch_gear", caption = " Aleutian Islands Pacific cod catch history, with federal catches by gear type, from 1991-2024 (through August 14). The blue dot represents the ABC for 2024.")`



\pagebreak


```{r catchbygear,echo=FALSE}

par(mfrow=c(3,1))
par(mar=c(3,3,2,1))
par(oma=c(1,1.5,0,0))

catz4=reshape2::melt(catz3,value.name=c("Month"))
colnames(catz4)=c("Month","Gear","Catch")
catz5=catz4[13:48,]

ggplot(catz5,aes(x=Month,y=Catch/5,fill=Gear))+geom_bar(stat="identity")+scale_x_continuous(breaks=seq(1,12,1))+ylab("Catch (t)")+theme_bw()


```

`r figure_nums(name="catchbygear",caption = paste(" Aleutian Islands Pacific cod average catch (t) by month per year and gear from January 1, 2020 - August 14, 2024. ",sep=""))`


\pagebreak


\pagebreak

```{r TARGET, echo=FALSE, message=FALSE}

#TARG=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/Groundfish Total Catch by Fishery_ALL_TARGETS_8_14_24.csv",header=TRUE)
#Target=names(table(TARG$Trip.Target.Group))
#Yrs=as.numeric(names(table(TARG$Year)))
#TARGmat=matrix(0,length(Yrs),length(Target))

#for(i in 1:length(Target)){
#  for(j in 1:length(Yrs)){
#    TARGmat[j,i]=round(sum(TARG$Catch..mt.[which(TARG$Year==Yrs[j]&TARG$Trip.Target.Group==Target[i])]))
#  }
#}
#rownames(TARGmat)=Yrs
#colnames(TARGmat)=Target

#TARGmat[,5]=TARGmat[,4]+TARGmat[,5]
#TARGmat=TARGmat[,c(1,2,3,5,6,7,8,9)]
#write.csv(TARGmat,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/TARGMAT.csv")

#TARGmat1=reshape2::melt(TARGmat,value.name="Year")
#colnames(TARGmat1)=c("Year","Target","Value")
#write.csv(TARGmat1,"/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/TARGMAT1.csv")

TARGmat1=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2024/TARGMAT1.csv")

ggplot() + geom_area(data=TARGmat1, aes(x=Year, y=Value, fill=Target)) + 
                 guides(fill = guide_legend(reverse=FALSE))+theme_bw()

```

`r figure_nums(name = "TARGET", caption = " Proportion of Pacific cod caught in targeted fisheries in the Aleutian Islands (541, 542, and 543) from 1991 through August 14, 2024.")`


\pagebreak




```{r REMA,echo=FALSE,message=FALSE}


```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2023/REMA/REMA.pdf}
\end{center}

`r figure_nums(name = "REMA", caption = " Survey index of biomass and Tier 5 fit using a random effects model.")`

\pagebreak



```{r Recruitment,echo=FALSE}

```

\begin{center}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/Recruitment_M24.pdf}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/Recruitment.pdf}
\end{center}

`r figure_nums(name = "Recruitment", caption = " Recruitment estimates for all Models 24.0, 24.1 (upper panel), and six bridging models, M24.0A, M24.0B, M24.0C, M24.0D, M24.0E, and M24.0F (lower panel).")`

\pagebreak



```{r Index,echo=FALSE}

```

\begin{center}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/Index_M24.pdf}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/Index.pdf}
\end{center}

`r figure_nums(name = "Index", caption = " Model fit to survey index for all Models 24.0, 24.1 (upper panel), and six bridging models, M24.0A, M24.0B, M24.0C, M24.0D, M24.0E, and M24.0F (lower panel).")`

\pagebreak




```{r FracUnfished,echo=FALSE}

```

\begin{center}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/FracUnfished_M24.pdf}
\includegraphics[width=5in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/FracUnfished.pdf}
\end{center}


`r figure_nums(name = "FracUnfished", caption = " Spawning biomass relative to unfished for all Models 24.0, 24.1 (upper panel), and six bridging models, M24.0A, M24.0B, M24.0C, M24.0D, M24.0E, and M24.0F (lower panel).")`

\pagebreak



\pagebreak

```{r Growth,echo=FALSE}

```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/GrowthCurves.pdf}
\end{center}

`r figure_nums(name = "Growth", caption = " Growth curves for Models 24.1, 24.0A, 24.0FB, 24.0C, 24.0D, 24.0E, 24.0F, and 24.0G. Model 24.0G used the von Bertalanffy growth curve, but all others used the Richards growth curve. Model 24.0A used the full length and age composition data, but Models 24.0F and 24.0G used maximum age 10+ and maximum length 117. Model 24.1 further improved the fit through reduced CV on younger ages.")`




\pagebreak

```{r agerainbow,echo=FALSE,message=FALSE}
cod_barplot=read.csv("/Users/ingrid.spies/Documents/WorkDellStuff/Assessments/AI_Cod/2022/cod_barplot.csv",header=TRUE)
ggplot(cod_barplot, aes(x=Length,y=Frequency,fill = factor(Age)))+geom_density(stat="identity",alpha=0.8,color=NA)+theme_bw()+scale_color_brewer()+xlab("Length (mm)")+theme_bw()+guides(fill=guide_legend(title="Age"),colour=FALSE,size=FALSE)
```
`r figure_nums(name="agerainbow",caption = " Length frequency by age of cod collected from surveys from 1991-2018.")`

\pagebreak



```{r Selectivity,echo=FALSE}

```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/Selectivity.pdf}
\end{center}

`r figure_nums(name = "Selectivity", caption = " Survey and fishery selectivity curves for Models 24.1, 24.0A, 24.0FB, 24.0C, 24.0D, 24.0E, 24.0F, and 24.0G. Model 24.0G used the von Bertalanffy growth curve, but all others used the Richards growth curve. Model 24.0A used the full length and age composition data, but Models 24.0F and 24.0G used maximum age 10+ and maximum length 117+ cm.")`

\pagebreak


```{r CV_likeprof,echo=FALSE}

```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/LikelihoodProfile_CVyoung/CVLikeplot.pdf}
\end{center}

`r figure_nums(name = "CV_likeprof", caption = " Likelihood profile over the coefficient of variation (CV) over growth curve younger ages.")`

\pagebreak



```{r LengthFit,echo=FALSE}

```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_baseA/LengthFit.pdf}
\end{center}

`r figure_nums(name = "LengthFit", caption = " Model fit to observed length frequencies for survey and fishery data, Model 24.1 (left) and 24.0A (right).")`

\pagebreak



```{r Regime, echo=FALSE,message=FALSE}

heat <-  rasterGrob(as.raster(readPNG("/Users/ingrid.spies/Documents/AI_PCOD/2024/AIPcod2024/AI_heatwavedays.png"), interpolate = FALSE))

grid.arrange(heat)

```

`r figure_nums(name = "Regime", caption = " The number of days under heatwave conditions for the western, central, and eastern Aleutian Islands, 1982 - 2023.")`

\pagebreak


```{r Heatwave_2024, echo=FALSE,message=FALSE}

```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/data/Heatwave_2024.pdf}
\end{center}


`r figure_nums(name = "Heatwave_2024", caption = " Aleutian Islands mean sea surface temperature for the western, central, and eastern region, 2024 compared with 2023 and previous years. In 2024 there were several short periods considered heatwave conditions in the Aleutian Islands, but less than in previous years. ")`

\pagebreak


```{r lnQ,echo=FALSE}

```

\begin{center}
\includegraphics[width=8in,angle=0,origin=c]{//Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/LikelihoodProfile_LnQ/lnQ.pdf}
\end{center}

`r figure_nums(name = "lnQ", caption = " Likelihood profile over the log of catchability (q), from -0.8 to 0.8 in increments of 0.1.")`

\pagebreak


```{r Kobe,echo=FALSE}

```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/Kobe24_1.pdf}
\end{center}

`r figure_nums(name = "Kobe", caption = paste(" A Kobe plot demonstrating the stock status uncertainty over SSB/SSBmsy and F/Fmsy, indicates a 97.6% probability that the stock status is between 0 and SSB35%, and that the fishing mortality rate is below F40%. The triangle represents the first year (1991) and the large circle the final year (2024). Grey dots provide uncertainty among model runs for the stock status in the final year."))`




\pagebreak

```{r R0,echo=FALSE,message=FALSE}


```



\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/LikelihoodProfile_R0/R0.pdf}
\end{center}

`r figure_nums(name = "R0", caption = " Likelihood profile over initial recruitment, R0, from 10.4 to 12.")`

\pagebreak



```{r Catch_scenarios,echo=FALSE,message=FALSE}


```

\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/AK_Scenarios/AK_Scenarios_CatchALL.pdf}
\end{center}

`r figure_nums(name = "Catch_scenarios", caption = " Catch under seven NPFMC projection scenarios for Model 24.1.")`


\pagebreak

```{r Projection_scenarios,echo=FALSE,message=FALSE}


```


\begin{center}
\includegraphics[width=6in,angle=0,origin=c]{/Users/ingrid.spies/Documents/AI_PCOD/2024/Models/Sensitivity_Anal/M24_1/run/AK_Scenarios/AK_Scenarios_ProjALL.pdf}
\end{center}

`r figure_nums(name = "Projection_scenarios", caption = " Projected spawning stock biomass under seven NPFMC projection scenarios for Model 24.1.")`












